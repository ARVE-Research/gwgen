<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>gwgen.utils &mdash; gwgen 1.0.0 documentation</title>
    
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1.0.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="gwgen 1.0.0 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for gwgen.utils</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">os.path</span> <span class="kn">as</span> <span class="nn">osp</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">abc</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">chain</span><span class="p">,</span> <span class="n">groupby</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">docrep</span>
<span class="kn">from</span> <span class="nn">tempfile</span> <span class="kn">import</span> <span class="n">mkdtemp</span>
<span class="kn">from</span> <span class="nn">psyplot.compat.pycompat</span> <span class="kn">import</span> <span class="n">OrderedDict</span><span class="p">,</span> <span class="n">filterfalse</span>
<span class="kn">from</span> <span class="nn">psyplot.config.rcsetup</span> <span class="kn">import</span> <span class="n">safe_list</span>


<span class="n">docstrings</span> <span class="o">=</span> <span class="n">docrep</span><span class="o">.</span><span class="n">DocstringProcessor</span><span class="p">()</span>


<span class="n">float_patt</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[+-]?(\d+(\.\d*)?|\.\d+)([eE][+-]?\d+)?&#39;</span><span class="p">)</span>


<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="k">if</span> <span class="n">six</span><span class="o">.</span><span class="n">PY2</span><span class="p">:</span>
    <span class="n">FileExistsError</span> <span class="o">=</span> <span class="ne">OSError</span>


<div class="viewcode-block" id="download_file"><a class="viewcode-back" href="../../api/gwgen.utils.html#gwgen.utils.download_file">[docs]</a><span class="k">def</span> <span class="nf">download_file</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Download a file from the internet</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    url: str</span>
<span class="sd">        The url of the file</span>
<span class="sd">    target: str or None</span>
<span class="sd">        The path where the downloaded file shall be saved. If None, it will be</span>
<span class="sd">        saved to a temporary directory</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    file_name: str</span>
<span class="sd">        the downloaded filename&quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Downloading </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">target</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">osp</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">osp</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">target</span><span class="p">)):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">osp</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">target</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">six</span><span class="o">.</span><span class="n">PY3</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">urllib</span> <span class="kn">import</span> <span class="n">request</span>
        <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">target</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">urllib</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">target</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># workaround. clean up urls. otherwise you get problems if downloading</span>
        <span class="c1"># more than one file from the same source</span>
        <span class="c1"># (http://bugs.python.org/issue27973)</span>
        <span class="n">urllib</span><span class="o">.</span><span class="n">urlcleanup</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">ret</span></div>


<div class="viewcode-block" id="dir_contains"><a class="viewcode-back" href="../../api/gwgen.utils.html#gwgen.utils.dir_contains">[docs]</a><span class="k">def</span> <span class="nf">dir_contains</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">exists</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check if a file of directory is contained in another.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dirname: str</span>
<span class="sd">        The base directory that should contain `path`</span>
<span class="sd">    path: str</span>
<span class="sd">        The name of a directory or file that should be in `dirname`</span>
<span class="sd">    exists: bool</span>
<span class="sd">        If True, the `path` and `dirname` must exist</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    `path` and `dirname` must be either both absolute or both relative</span>
<span class="sd">    paths&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">exists</span><span class="p">:</span>
        <span class="n">dirname</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">dirname</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">six</span><span class="o">.</span><span class="n">PY3</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">osp</span><span class="o">.</span><span class="n">samefile</span><span class="p">(</span><span class="n">osp</span><span class="o">.</span><span class="n">commonpath</span><span class="p">([</span><span class="n">dirname</span><span class="p">,</span> <span class="n">path</span><span class="p">]),</span> <span class="n">dirname</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">osp</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">osp</span><span class="o">.</span><span class="n">samefile</span><span class="p">(</span>
                <span class="n">osp</span><span class="o">.</span><span class="n">commonprefix</span><span class="p">([</span><span class="n">dirname</span><span class="p">,</span> <span class="n">path</span><span class="p">]),</span> <span class="n">dirname</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dirname</span> <span class="ow">in</span> <span class="n">osp</span><span class="o">.</span><span class="n">commonprefix</span><span class="p">([</span><span class="n">dirname</span><span class="p">,</span> <span class="n">path</span><span class="p">])</span></div>


<div class="viewcode-block" id="isstring"><a class="viewcode-back" href="../../api/gwgen.utils.html#gwgen.utils.isstring">[docs]</a><span class="k">def</span> <span class="nf">isstring</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">)</span></div>

<span class="n">docstrings</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;str_ranges.s_help&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    A comma (``&#39;,&#39;``) separated string. A single value in this string</span>
<span class="s2">    represents one number, ranges can also be used via a separation by</span>
<span class="s2">    comma (``&#39;-&#39;``). Hence, ``&#39;2009,2012-2015&#39;`` will be</span>
<span class="s2">    converted to ``[2009,2012, 2013, 2014]`` and ``2009,2012-2015-2`` to</span>
<span class="s2">    ``[2009, 2012, 2015]``&quot;&quot;&quot;</span>


<span class="n">minus_patt</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(?&lt;!^)(?&lt;!-)-&#39;</span><span class="p">)</span>


<span class="nd">@docstrings.dedent</span>
<div class="viewcode-block" id="str_ranges"><a class="viewcode-back" href="../../api/gwgen.utils.html#gwgen.utils.str_ranges">[docs]</a><span class="k">def</span> <span class="nf">str_ranges</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a string of comma separated values to an iterable</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    s: str%(str_ranges.s_help)s</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list</span>
<span class="sd">        The values in s converted to a list&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">get_numbers</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="n">splitted</span> <span class="o">=</span> <span class="n">minus_patt</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">nums</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">minus_patt</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">splitted</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nums</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">nums</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">*</span><span class="n">nums</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">get_numbers</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))))</span></div>


<div class="viewcode-block" id="unique_everseen"><a class="viewcode-back" href="../../api/gwgen.utils.html#gwgen.utils.unique_everseen">[docs]</a><span class="k">def</span> <span class="nf">unique_everseen</span><span class="p">(</span><span class="n">iterable</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;List unique elements, preserving order. Remember all elements ever seen.</span>

<span class="sd">    Function taken from https://docs.python.org/2/library/itertools.html&quot;&quot;&quot;</span>
    <span class="c1"># unique_everseen(&#39;AAAABBBCCDAABBB&#39;) --&gt; A B C D</span>
    <span class="c1"># unique_everseen(&#39;ABBCcAD&#39;, str.lower) --&gt; A B C D</span>
    <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">seen_add</span> <span class="o">=</span> <span class="n">seen</span><span class="o">.</span><span class="n">add</span>
    <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">filterfalse</span><span class="p">(</span><span class="n">seen</span><span class="o">.</span><span class="fm">__contains__</span><span class="p">,</span> <span class="n">iterable</span><span class="p">):</span>
            <span class="n">seen_add</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">element</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">iterable</span><span class="p">:</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">key</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                <span class="n">seen_add</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">element</span></div>


<div class="viewcode-block" id="get_next_name"><a class="viewcode-back" href="../../api/gwgen.utils.html#gwgen.utils.get_next_name">[docs]</a><span class="k">def</span> <span class="nf">get_next_name</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%i</span><span class="s1">&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the next name that numerically follows `old`&quot;&quot;&quot;</span>
    <span class="n">nums</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;\d+&#39;</span><span class="p">,</span> <span class="n">old</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">nums</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Could not get the next name because the old name &quot;</span>
                         <span class="s2">&quot;has no numbers in it&quot;</span><span class="p">)</span>
    <span class="n">num0</span> <span class="o">=</span> <span class="n">nums</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">num1</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">num0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">old</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">num0</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">num1</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></div>


<span class="n">docstrings</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;get_value_note&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    If the key goes some</span>
<span class="s2">    levels deeper, keys may be separated by a ``&#39;.&#39;`` (e.g.</span>
<span class="s2">    ``&#39;namelists.weathergen&#39;``). Hence, to insert a ``&#39;,&#39;``, it must</span>
<span class="s2">    be escaped by a preceeding ``&#39;</span><span class="se">\&#39;</span><span class="s2">``.&quot;&quot;&quot;</span>


<span class="nd">@docstrings.dedent</span>
<div class="viewcode-block" id="go_through_dict"><a class="viewcode-back" href="../../api/gwgen.utils.html#gwgen.utils.go_through_dict">[docs]</a><span class="k">def</span> <span class="nf">go_through_dict</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">setdefault</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Split up the `key` by . and get the value from the base dictionary `d`</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    key: str</span>
<span class="sd">        The key in the `config` configuration. %(get_value_note)s</span>
<span class="sd">    d: dict</span>
<span class="sd">        The configuration dictionary containing the key</span>
<span class="sd">    setdefault: callable</span>
<span class="sd">        If not None and an item is not existent in `d`, it is created by</span>
<span class="sd">        calling the given function</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        The last level of the key</span>
<span class="sd">    dict</span>
<span class="sd">        The dictionary in `d` that contains the last level of the key</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">patt</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(?&lt;!</span><span class="se">\\</span><span class="s1">)\.&#39;</span><span class="p">)</span>
    <span class="n">sub_d</span> <span class="o">=</span> <span class="n">d</span>
    <span class="n">splitted</span> <span class="o">=</span> <span class="n">patt</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">splitted</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">splitted</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">setdefault</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">sub_d</span> <span class="o">=</span> <span class="n">sub_d</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">setdefault</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sub_d</span> <span class="o">=</span> <span class="n">sub_d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">k</span><span class="p">,</span> <span class="n">sub_d</span></div>


<div class="viewcode-block" id="safe_csv_append"><a class="viewcode-back" href="../../api/gwgen.utils.html#gwgen.utils.safe_csv_append">[docs]</a><span class="k">def</span> <span class="nf">safe_csv_append</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convenience method to dump a data frame to csv without removing the old</span>

<span class="sd">    This function dumps the given `df` to the file specified by `path`. If</span>
<span class="sd">    `path` already exists, we read the header of the file and sort `df`</span>
<span class="sd">    according to this header</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df: pandas.DataFrame</span>
<span class="sd">        The data frame to store</span>
<span class="sd">    path: str</span>
<span class="sd">        The path where to store the data</span>
<span class="sd">    ``**kwargs``</span>
<span class="sd">        Any other keyword for the :meth:`pandas.DataFrame.to_csv` method&quot;&quot;&quot;</span>
    <span class="n">exists</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">exists</span><span class="p">:</span>
        <span class="n">idx_names</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span>
        <span class="n">order</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span>
                 <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">idx_names</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">order</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="n">order</span><span class="p">]</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="ow">not</span> <span class="n">exists</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="ordered_move"><a class="viewcode-back" href="../../api/gwgen.utils.html#gwgen.utils.ordered_move">[docs]</a><span class="k">def</span> <span class="nf">ordered_move</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">to_move</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Move a key in an ordered dictionary to another position</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    d: collections.OrderedDict</span>
<span class="sd">        The dictionary containing the keys</span>
<span class="sd">    to_move: str</span>
<span class="sd">        The key to move</span>
<span class="sd">    pos: str</span>
<span class="sd">        The name of the key that should be followed by `to_move`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
    <span class="n">i2move</span> <span class="o">=</span> <span class="n">keys</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">to_move</span><span class="p">)</span>
    <span class="n">orig_pos</span> <span class="o">=</span> <span class="n">keys</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">i2move</span> <span class="o">&gt;</span> <span class="n">orig_pos</span><span class="p">:</span>
        <span class="n">d</span><span class="o">.</span><span class="n">move_to_end</span><span class="p">(</span><span class="n">to_move</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">[</span><span class="n">orig_pos</span><span class="p">:</span><span class="n">i2move</span><span class="p">]</span> <span class="o">+</span> <span class="n">keys</span><span class="p">[</span><span class="n">i2move</span><span class="o">+</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">d</span><span class="o">.</span><span class="n">move_to_end</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">[</span><span class="n">i2move</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="n">orig_pos</span><span class="p">]:</span>
            <span class="n">d</span><span class="o">.</span><span class="n">move_to_end</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">d</span><span class="o">.</span><span class="n">move_to_end</span><span class="p">(</span><span class="n">to_move</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">[</span><span class="n">orig_pos</span><span class="p">:]:</span>
            <span class="n">d</span><span class="o">.</span><span class="n">move_to_end</span><span class="p">(</span><span class="n">key</span><span class="p">)</span></div>


<span class="n">_engines</span> <span class="o">=</span> <span class="p">{}</span>


<span class="nd">@docstrings.get_sectionsf</span><span class="p">(</span><span class="s1">&#39;get_postgres_engine&#39;</span><span class="p">)</span>
<span class="nd">@docstrings.dedent</span>
<div class="viewcode-block" id="get_postgres_engine"><a class="viewcode-back" href="../../api/gwgen.utils.html#gwgen.utils.get_postgres_engine">[docs]</a><span class="k">def</span> <span class="nf">get_postgres_engine</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                        <span class="n">create</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the engine to access the given `database`</span>

<span class="sd">    This method creates an engine using sqlalchemy&#39;s create_engine function</span>
<span class="sd">    to access the given `database` via postgresql. If the database is not</span>
<span class="sd">    existent, it will be created</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    database: str</span>
<span class="sd">        The name of a psql database. If provided, the processed data will</span>
<span class="sd">        be stored</span>
<span class="sd">    user: str</span>
<span class="sd">        The username to use when logging into the database</span>
<span class="sd">    host: str</span>
<span class="sd">        the host which runs the database server</span>
<span class="sd">    port: int</span>
<span class="sd">        The port to use to log into the the database</span>
<span class="sd">    create: bool</span>
<span class="sd">        If True, it is tried to create the database if not existent as postgres</span>
<span class="sd">        user</span>
<span class="sd">    test: bool</span>
<span class="sd">        If True, test the connection before returning the engine</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    sqlalchemy.engine.base.Engine</span>
<span class="sd">        Tha engine to access the database</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The engine is for single usage!&quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">sqlalchemy</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="n">base_str</span> <span class="o">=</span> <span class="s1">&#39;postgresql://&#39;</span>
    <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
        <span class="n">base_str</span> <span class="o">+=</span> <span class="n">user</span> <span class="o">+</span> <span class="s1">&#39;@&#39;</span>
    <span class="n">base_str</span> <span class="o">+=</span> <span class="n">host</span>
    <span class="k">if</span> <span class="n">port</span><span class="p">:</span>
        <span class="n">base_str</span> <span class="o">+=</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="n">port</span>
    <span class="n">engine_str</span> <span class="o">=</span> <span class="n">base_str</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">database</span>  <span class="c1"># to create the database</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating engine with </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">engine_str</span><span class="p">)</span>
    <span class="n">engine</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">create_engine</span><span class="p">(</span><span class="n">engine_str</span><span class="p">,</span>
                                      <span class="n">poolclass</span><span class="o">=</span><span class="n">sqlalchemy</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">NullPool</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">test</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Try to connect...&quot;</span><span class="p">)</span>
            <span class="n">conn</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">exc</span><span class="o">.</span><span class="n">OperationalError</span><span class="p">:</span>
            <span class="c1"># data base does not exist, so create it</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Failed...&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">create</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Creating database by logging into postgres&quot;</span><span class="p">)</span>
                <span class="n">pengine</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">create_engine</span><span class="p">(</span><span class="n">base_str</span> <span class="o">+</span> <span class="s1">&#39;/postgres&#39;</span><span class="p">)</span>
                <span class="n">conn</span> <span class="o">=</span> <span class="n">pengine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;commit&#39;</span><span class="p">)</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;CREATE DATABASE &#39;</span> <span class="o">+</span> <span class="n">database</span><span class="p">)</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="n">engine_str</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">engine</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">create_engine</span><span class="p">(</span>
                <span class="n">engine_str</span><span class="p">,</span> <span class="n">poolclass</span><span class="o">=</span><span class="n">sqlalchemy</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">NullPool</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Done.&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">engine</span><span class="p">,</span> <span class="n">engine_str</span></div>


<div class="viewcode-block" id="file_len"><a class="viewcode-back" href="../../api/gwgen.utils.html#gwgen.utils.file_len">[docs]</a><span class="k">def</span> <span class="nf">file_len</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the number of lines in `fname`&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
            <span class="k">pass</span>
    <span class="k">return</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span></div>


<div class="viewcode-block" id="get_module_path"><a class="viewcode-back" href="../../api/gwgen.utils.html#gwgen.utils.get_module_path">[docs]</a><span class="k">def</span> <span class="nf">get_module_path</span><span class="p">(</span><span class="n">mod</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convenience method to get the directory of a given python module&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">osp</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getabsfile</span><span class="p">(</span><span class="n">mod</span><span class="p">))</span></div>


<div class="viewcode-block" id="get_toplevel_module"><a class="viewcode-back" href="../../api/gwgen.utils.html#gwgen.utils.get_toplevel_module">[docs]</a><span class="k">def</span> <span class="nf">get_toplevel_module</span><span class="p">(</span><span class="n">mod</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">mod</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span></div>


<span class="k">def</span> <span class="nf">_requirement_property</span><span class="p">(</span><span class="n">requirement</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">get_x</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_requirements</span><span class="p">[</span><span class="n">requirement</span><span class="p">]</span>

    <span class="k">return</span> <span class="nb">property</span><span class="p">(</span>
        <span class="n">get_x</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="n">requirement</span> <span class="o">+</span> <span class="s2">&quot; parameterization instance&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="append_doc"><a class="viewcode-back" href="../../api/gwgen.utils.html#gwgen.utils.append_doc">[docs]</a><span class="k">def</span> <span class="nf">append_doc</span><span class="p">(</span><span class="n">namedtuple_cls</span><span class="p">,</span> <span class="n">doc</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">six</span><span class="o">.</span><span class="n">PY3</span><span class="p">:</span>
        <span class="n">namedtuple_cls</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">doc</span>
        <span class="k">return</span> <span class="n">namedtuple_cls</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">class</span> <span class="nc">DocNamedTuple</span><span class="p">(</span><span class="n">namedtuple_cls</span><span class="p">):</span>
            <span class="vm">__doc__</span> <span class="o">=</span> <span class="n">namedtuple_cls</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">doc</span>
            <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>
        <span class="n">DocNamedTuple</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="n">namedtuple_cls</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="k">return</span> <span class="n">DocNamedTuple</span></div>


<span class="n">_SetupConfig</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span>
    <span class="s1">&#39;_SetupConfig&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;setup_from&#39;</span><span class="p">,</span> <span class="s1">&#39;to_csv&#39;</span><span class="p">,</span> <span class="s1">&#39;to_db&#39;</span><span class="p">,</span> <span class="s1">&#39;remove&#39;</span><span class="p">])</span>

<span class="n">_SetupConfig</span> <span class="o">=</span> <span class="n">append_doc</span><span class="p">(</span><span class="n">_SetupConfig</span><span class="p">,</span> <span class="n">docstrings</span><span class="o">.</span><span class="n">get_sections</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Configuration for the setup of tasks via their :meth:`~TaskBase.setup`</span>

<span class="s2">Parameters</span>
<span class="s2">----------</span>
<span class="s2">setup_from: { &#39;scratch&#39; | &#39;file&#39; | &#39;db&#39; | None }</span>
<span class="s2">    The method how to setup the instance either from</span>

<span class="s2">    ``&#39;scratch&#39;``</span>
<span class="s2">        To set up the task from the raw data</span>
<span class="s2">    ``&#39;file&#39;``</span>
<span class="s2">        Set up the task from an existing file</span>
<span class="s2">    ``&#39;db&#39;``</span>
<span class="s2">        Set up the task from a database</span>
<span class="s2">    ``None``</span>
<span class="s2">        If the file name of this this task exists, use this one,</span>
<span class="s2">        otherwise a database is provided, use this one, otherwise go</span>
<span class="s2">        from scratch</span>
<span class="s2">to_csv: bool</span>
<span class="s2">    If True, the data at setup will be written to a csv file</span>
<span class="s2">to_db: bool</span>
<span class="s2">    If True, the data at setup will be written to into a database</span>
<span class="s2">remove: bool</span>
<span class="s2">    If True and the old data file already exists, remove before writing to it</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">,</span> <span class="s1">&#39;_SetupConfig&#39;</span><span class="p">))</span>


<span class="n">_RunConfig</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span>
    <span class="s1">&#39;_RunConfig&#39;</span><span class="p">,</span>
    <span class="p">[</span><span class="s1">&#39;plot_output&#39;</span><span class="p">,</span> <span class="s1">&#39;nc_output&#39;</span><span class="p">,</span> <span class="s1">&#39;project_output&#39;</span><span class="p">,</span> <span class="s1">&#39;new_project&#39;</span><span class="p">,</span> <span class="s1">&#39;project&#39;</span><span class="p">,</span>
     <span class="s1">&#39;close&#39;</span><span class="p">])</span>

<span class="n">_RunConfig</span> <span class="o">=</span> <span class="n">append_doc</span><span class="p">(</span><span class="n">_RunConfig</span><span class="p">,</span> <span class="n">docstrings</span><span class="o">.</span><span class="n">get_sections</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Configuration for the run of tasks via their :meth:`~TaskBase.setup`</span>

<span class="s2">Parameters</span>
<span class="s2">----------</span>
<span class="s2">plot_output: str</span>
<span class="s2">    An alternative path to use for the PDF file of the plot</span>
<span class="s2">nc_output: str</span>
<span class="s2">    An alternative path (or multiples depending on the task) to use for the</span>
<span class="s2">    netCDF file of the plot data</span>
<span class="s2">project_output: str</span>
<span class="s2">    An alternative path to use for the psyplot project file of the plot</span>
<span class="s2">new_project: bool</span>
<span class="s2">    If True, a new project will be created even if a file in `project_output`</span>
<span class="s2">    exists already</span>
<span class="s2">project: str</span>
<span class="s2">    The path to a psyplot project file to use for this parameterization</span>
<span class="s2">close: bool</span>
<span class="s2">    Close the project at the end</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">,</span> <span class="s1">&#39;_RunConfig&#39;</span><span class="p">))</span>

<span class="n">TaskConfig</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span>
    <span class="s1">&#39;TaskConfig&#39;</span><span class="p">,</span> <span class="n">_SetupConfig</span><span class="o">.</span><span class="n">_fields</span> <span class="o">+</span> <span class="n">_RunConfig</span><span class="o">.</span><span class="n">_fields</span><span class="p">)</span>

<span class="n">TaskConfig</span> <span class="o">=</span> <span class="n">append_doc</span><span class="p">(</span><span class="n">TaskConfig</span><span class="p">,</span> <span class="n">docstrings</span><span class="o">.</span><span class="n">get_sections</span><span class="p">(</span>
    <span class="n">docstrings</span><span class="o">.</span><span class="n">dedents</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Configuration of tasks for their :meth:`~TaskBase.setup` and</span>
<span class="s2">:meth:`~TaskBase.run` methods.</span>

<span class="s2">Parameters</span>
<span class="s2">----------</span>
<span class="s2">%(_SetupConfig.parameters)s</span>
<span class="s2">%(_RunConfig.parameters)s&quot;&quot;&quot;</span><span class="p">),</span> <span class="s1">&#39;TaskConfig&#39;</span><span class="p">))</span>


<span class="nd">@docstrings.dedent</span>
<div class="viewcode-block" id="default_config"><a class="viewcode-back" href="../../api/gwgen.utils.html#gwgen.utils.default_config">[docs]</a><span class="k">def</span> <span class="nf">default_config</span><span class="p">(</span>
        <span class="n">setup_from</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">to_csv</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">to_db</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">remove</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">plot_output</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">nc_output</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">project_output</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">new_project</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">close</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The default configuration for TaskBase instances. See also the</span>
<span class="sd">    :attr:`TaskBase.default_config` attribute</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    %(TaskConfig.parameters)s&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">TaskConfig</span><span class="p">(</span><span class="n">setup_from</span><span class="p">,</span> <span class="n">to_csv</span><span class="p">,</span> <span class="n">to_db</span><span class="p">,</span> <span class="n">remove</span><span class="p">,</span> <span class="n">plot_output</span><span class="p">,</span>
                      <span class="n">nc_output</span><span class="p">,</span> <span class="n">project_output</span><span class="p">,</span> <span class="n">new_project</span><span class="p">,</span> <span class="n">project</span><span class="p">,</span> <span class="n">close</span><span class="p">)</span></div>


<div class="viewcode-block" id="TaskMeta"><a class="viewcode-back" href="../../api/gwgen.utils.html#gwgen.utils.TaskMeta">[docs]</a><span class="k">class</span> <span class="nc">TaskMeta</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABCMeta</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Meta class for the :class:`TaskBase`&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">namespace</span><span class="p">):</span>
        <span class="n">new_cls</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">TaskMeta</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span>
            <span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">namespace</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new_cls</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="n">new_cls</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_cls</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">requirement</span> <span class="ow">in</span> <span class="n">new_cls</span><span class="o">.</span><span class="n">setup_requires</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">new_cls</span><span class="p">,</span> <span class="n">requirement</span><span class="p">,</span> <span class="n">_requirement_property</span><span class="p">(</span><span class="n">requirement</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">new_cls</span></div>


<span class="k">def</span> <span class="nf">_param_worker</span><span class="p">(</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">gwgen.parameterization</span> <span class="kn">import</span> <span class="n">Parameterizer</span>
    <span class="k">return</span> <span class="n">Parameterizer</span><span class="o">.</span><span class="n">process_data</span><span class="p">(</span>
        <span class="n">db_locks</span><span class="o">=</span><span class="n">_db_locks</span><span class="p">,</span> <span class="n">file_locks</span><span class="o">=</span><span class="n">_file_locks</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<div class="viewcode-block" id="init_interprocess_locks"><a class="viewcode-back" href="../../api/gwgen.utils.html#gwgen.utils.init_interprocess_locks">[docs]</a><span class="k">def</span> <span class="nf">init_interprocess_locks</span><span class="p">(</span><span class="n">db_locks</span><span class="p">,</span> <span class="n">file_locks</span><span class="p">,</span> <span class="n">lock_dir</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">fasteners</span> <span class="kn">import</span> <span class="n">InterProcessLock</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Initializing </span><span class="si">%i</span><span class="s1"> locks&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">db_locks</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_locks</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">db_lock</span> <span class="ow">in</span> <span class="n">db_locks</span><span class="p">:</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lock_dir</span><span class="p">,</span> <span class="s1">&#39;db_&#39;</span> <span class="o">+</span> <span class="n">db_lock</span> <span class="o">+</span> <span class="s1">&#39;.lock&#39;</span><span class="p">)</span>
        <span class="n">_db_locks</span><span class="p">[</span><span class="n">db_lock</span><span class="p">]</span> <span class="o">=</span> <span class="n">InterProcessLock</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">file_lock</span> <span class="ow">in</span> <span class="n">file_locks</span><span class="p">:</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lock_dir</span><span class="p">,</span>
                         <span class="s1">&#39;file_&#39;</span> <span class="o">+</span> <span class="n">osp</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file_lock</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.lock&#39;</span><span class="p">)</span>
        <span class="n">_file_locks</span><span class="p">[</span><span class="n">file_lock</span><span class="p">]</span> <span class="o">=</span> <span class="n">InterProcessLock</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span></div>


<div class="viewcode-block" id="init_locks"><a class="viewcode-back" href="../../api/gwgen.utils.html#gwgen.utils.init_locks">[docs]</a><span class="k">def</span> <span class="nf">init_locks</span><span class="p">(</span><span class="n">db_locks</span><span class="p">,</span> <span class="n">file_locks</span><span class="p">):</span>
    <span class="n">_db_locks</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">db_locks</span><span class="p">)</span>
    <span class="n">_file_locks</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">file_locks</span><span class="p">)</span></div>

<span class="n">_db_locks</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">_file_locks</span> <span class="o">=</span> <span class="p">{}</span>


<div class="viewcode-block" id="enhanced_config"><a class="viewcode-back" href="../../api/gwgen.utils.html#gwgen.utils.enhanced_config">[docs]</a><span class="k">def</span> <span class="nf">enhanced_config</span><span class="p">(</span><span class="n">config_cls</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">config_cls</span><span class="o">.</span><span class="n">_fields</span> <span class="o">+</span> <span class="n">TaskConfig</span><span class="o">.</span><span class="n">_fields</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">append_doc</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">docstrings</span><span class="o">.</span><span class="n">get_sections</span><span class="p">(</span><span class="n">docstrings</span><span class="o">.</span><span class="n">dedents</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        Configuration of the :class:`EvaluationPreparation` class</span>

<span class="s2">        Parameters</span>
<span class="s2">        ----------</span>
<span class="s2">        %({}.parameters)s</span>
<span class="s2">        %(TaskConfig.parameters)s</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">config_cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)),</span> <span class="n">name</span><span class="p">))</span></div>


<span class="nd">@six.add_metaclass</span><span class="p">(</span><span class="n">TaskMeta</span><span class="p">)</span>
<div class="viewcode-block" id="TaskBase"><a class="viewcode-back" href="../../api/gwgen.utils.html#gwgen.utils.TaskBase">[docs]</a><span class="k">class</span> <span class="nc">TaskBase</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Abstract base class for parameterization and evaluation tasks</span>

<span class="sd">    Abstract base class that introduces the methods for the parameterization</span>
<span class="sd">    and evaluation framework. The name of the task is specified in the</span>
<span class="sd">    :attr:`name` attribute. You can implement the connection to other</span>
<span class="sd">    tasks (within the same framework) in the :attr:`setup_requires` attribute.</span>
<span class="sd">    The corresponding instances to the identifiers in the</span>
<span class="sd">    :attr:`setup_requires` attribute can later be accessed through the given</span>
<span class="sd">    attribute.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    Let&#39;s define a parameterizer that does nothing but setup_requires another</span>
<span class="sd">    parameterization task named *cloud* as connection::</span>

<span class="sd">        &gt;&gt;&gt; class CloudParameterizer(Parameterizer):</span>
<span class="sd">        ...     name = &#39;cloud&#39;</span>
<span class="sd">        ...     def setup_from_scratch(self):</span>
<span class="sd">        ...         pass</span>
<span class="sd">        ...</span>
<span class="sd">        &gt;&gt;&gt; class DummyParameterizer(Parameterizer):</span>
<span class="sd">        ...     setup_requires = [&#39;cloud&#39;]</span>
<span class="sd">        ...     name = &#39;dummy&#39;</span>
<span class="sd">        ...     def setup_from_scratch(self):</span>
<span class="sd">        ...         pass</span>
<span class="sd">        ...</span>
<span class="sd">        &gt;&gt;&gt; cloud = CloudParameterizer()</span>
<span class="sd">        &gt;&gt;&gt; dummy = DummyParameterizer(cloud=cloud)</span>
<span class="sd">        &gt;&gt;&gt; dummy.cloud is cloud</span>
<span class="sd">        True&quot;&quot;&quot;</span>

    <span class="c1">#: The registered parameterization classes (are set up automatically by</span>
    <span class="c1">#: :class:`TaskMeta`). If you want to start a new framework, set this</span>
    <span class="c1">#: variable at class definition of your framework base</span>
    <span class="n">_registry</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1">#: list of str. identifiers of required classes for this task</span>
    <span class="n">setup_requires</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1">#: required tasks for this instance. See :meth:`set_requirements`</span>
    <span class="n">_requirements</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c1">#: str. name of the task</span>
    <span class="n">name</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c1">#: pandas.DataFrame. The dataframe holding the daily data</span>
    <span class="n">data</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c1">#: str. The basename of the csv file where the data is stored by the</span>
    <span class="c1">#: :meth:`TaskBase.write2file` method and read by the</span>
    <span class="c1">#: :meth:`TaskBase.setup_from_file`</span>
    <span class="n">_datafile</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="c1">#: The database name to use</span>
    <span class="n">dbname</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="c1">#: str. summary of what this task does</span>
    <span class="n">summary</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="c1">#: dict. Formatoptions to use when making plots with this task</span>
    <span class="n">fmt</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1">#: bool. Boolean that is True if there is a run method for this task</span>
    <span class="n">has_run</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="c1">#: bool. Boolean that is True if the task can be setup in parallel</span>
    <span class="n">setup_parallel</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="c1">#: :class:`threading.Thread` objects that are started during the setup.</span>
    <span class="c1">#: It will be waited for them to finish before continuing with another</span>
    <span class="c1">#: process</span>
    <span class="n">threads</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">default_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The default configuration of this task inserted with the</span>
<span class="sd">        :attr:`pdf_file`, :attr:`nc_file` and :attr:`project_file` attributes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">default_config</span><span class="p">()</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span>
            <span class="n">plot_output</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pdf_file</span><span class="p">,</span> <span class="n">nc_output</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nc_file</span><span class="p">,</span>
            <span class="n">project_output</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project_file</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">data_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;str. Path to the directory where the source data of the project</span>
<span class="sd">        is located&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_config</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">param_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;str. Path to the directory were the processed parameterization</span>
<span class="sd">        data is stored&quot;&quot;&quot;</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;paramdir&#39;</span><span class="p">,</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;expdir&#39;</span><span class="p">],</span> <span class="s1">&#39;parameterization&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">osp</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">ret</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">FileExistsError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cloud_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;str. Path to the directory were the processed parameterization</span>
<span class="sd">        data is stored&quot;&quot;&quot;</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;clouddir&#39;</span><span class="p">,</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;expdir&#39;</span><span class="p">],</span> <span class="s1">&#39;cloud_parameterization&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">osp</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">ret</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">FileExistsError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">eval_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;str. Path to the directory were the processed evaluation data is</span>
<span class="sd">        stored&quot;&quot;&quot;</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;evaldir&#39;</span><span class="p">,</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;expdir&#39;</span><span class="p">],</span> <span class="s1">&#39;evaluation&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">osp</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">ret</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">FileExistsError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sa_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;str. Path to the directory were the processed sensitivity analysis</span>
<span class="sd">        data is stored&quot;&quot;&quot;</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;sadir&#39;</span><span class="p">,</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;expdir&#39;</span><span class="p">],</span> <span class="s1">&#39;sensitivity_analysis&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">osp</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">ret</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">FileExistsError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">input_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;str. Path to the directory were the input data is stored&quot;&quot;&quot;</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;indir&#39;</span><span class="p">,</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;expdir&#39;</span><span class="p">],</span> <span class="s1">&#39;input&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">osp</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">ret</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">FileExistsError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">reference_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The path to the reference file in the configuration&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s1">&#39;reference&#39;</span><span class="p">,</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_dir</span><span class="p">,</span> <span class="s1">&#39;reference.csv&#39;</span><span class="p">))</span>

    <span class="nd">@reference_path.setter</span>
    <span class="k">def</span> <span class="nf">reference_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;reference&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">df_ref</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The reference data frame&quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reference_path</span><span class="p">,</span>
                         <span class="n">index_col</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">,</span> <span class="s1">&#39;day&#39;</span><span class="p">])</span>
        <span class="n">stations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stations</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stations</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">stations</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">stations</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">stations</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="n">stations</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">input_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The path to the project input file in the configuration&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_dir</span><span class="p">,</span> <span class="s1">&#39;input.csv&#39;</span><span class="p">))</span>

    <span class="nd">@input_path.setter</span>
    <span class="k">def</span> <span class="nf">input_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">output_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;str. Path to the directory were the input data is stored&quot;&quot;&quot;</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;outdir&#39;</span><span class="p">,</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;expdir&#39;</span><span class="p">],</span> <span class="s1">&#39;output&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">osp</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">ret</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">FileExistsError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">output_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The path to the project output file in the configuration&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;outdata&#39;</span><span class="p">]</span>

    <span class="nd">@abc.abstractproperty</span>
    <span class="k">def</span> <span class="nf">task_data_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The directory where to store data&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">datafile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;str. The path to the csv file where the data is stored by the</span>
<span class="sd">        :meth:`Parameterizer.write2file` method and read by the</span>
<span class="sd">        :meth:`Parameterizer.setup_from_file`&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_datafile</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task_data_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datafile</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task_data_dir</span><span class="p">,</span> <span class="n">f</span><span class="p">),</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_datafile</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nc_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;NetCDF file for the project&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task_data_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;.nc&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">project_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Pickle file for the project&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task_data_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;.pkl&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pdf_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;pdf file with figures the project&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task_data_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;.pdf&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">engine</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The sqlalchemy engine to access the database&quot;&quot;&quot;</span>
        <span class="n">global_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_config</span>
        <span class="n">database</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s1">&#39;database&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s1">&#39;database&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;database&#39;</span><span class="p">)))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">database</span> <span class="ow">or</span> <span class="n">global_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;no_postgres&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="c1"># first we check whether everything works with the database</span>
        <span class="c1"># We add &#39;or None&#39; explicitly because otherwise the user would not be</span>
        <span class="c1"># able to reset the settings</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">global_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">None</span>
        <span class="n">port</span> <span class="o">=</span> <span class="n">global_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;port&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">None</span>
        <span class="n">host</span> <span class="o">=</span> <span class="n">global_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;host&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;127.0.0.1&#39;</span>
        <span class="k">return</span> <span class="n">get_postgres_engine</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sql_dtypes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The data types to write the data into a postgres database&quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">sqlalchemy</span>

        <span class="k">def</span> <span class="nf">get_names</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">chain</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="n">dtype</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;station_id&#39;</span><span class="p">:</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">INTEGER</span><span class="p">,</span> <span class="s1">&#39;tmin&#39;</span><span class="p">:</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">TEXT</span><span class="p">,</span> <span class="s1">&#39;prcp&#39;</span><span class="p">:</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s1">&#39;tmax&#39;</span><span class="p">:</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span> <span class="s1">&#39;mean_cloud&#39;</span><span class="p">:</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">REAL</span><span class="p">,</span>
            <span class="s1">&#39;wet_day&#39;</span><span class="p">:</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">SMALLINT</span><span class="p">,</span> <span class="s1">&#39;ndaymon&#39;</span><span class="p">:</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">SMALLINT</span><span class="p">,</span>
            <span class="s1">&#39;year&#39;</span><span class="p">:</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">SMALLINT</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">:</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">SMALLINT</span><span class="p">,</span>
            <span class="s1">&#39;day&#39;</span><span class="p">:</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">SMALLINT</span><span class="p">,</span> <span class="s1">&#39;hour&#39;</span><span class="p">:</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">SMALLINT</span><span class="p">,</span>
            <span class="s1">&#39;wind&#39;</span><span class="p">:</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">REAL</span><span class="p">}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_datafile</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="n">names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">get_names</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)))</span>
            <span class="n">used_types</span> <span class="o">=</span> <span class="n">names</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="n">n</span><span class="p">:</span> <span class="p">[</span><span class="n">dtype</span><span class="p">[</span><span class="n">n</span><span class="p">]]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">used_types</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">chain</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span><span class="p">))</span>
            <span class="k">return</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">val</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">dtype</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">names</span><span class="p">}</span>

    <span class="n">_logger</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">logger</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The logger of this task&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span>

    <span class="nd">@logger.setter</span>
    <span class="k">def</span> <span class="nf">logger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;serial&#39;</span><span class="p">):</span>
            <span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="kn">as</span> <span class="nn">mp</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="p">[</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                 <span class="n">mp</span><span class="o">.</span><span class="n">current_process</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="p">[</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">setup_from</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_config</span><span class="o">.</span><span class="n">setup_from</span>
        <span class="k">if</span> <span class="n">ret</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_setup</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setup_from</span> <span class="o">=</span> <span class="n">ret</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="nd">@setup_from.setter</span>
    <span class="k">def</span> <span class="nf">setup_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_config</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">setup_from</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>

    <span class="nd">@docstrings.get_sectionsf</span><span class="p">(</span><span class="s1">&#39;TaskBase&#39;</span><span class="p">)</span>
    <span class="nd">@docstrings.dedent</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stations</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">project_config</span><span class="p">,</span> <span class="n">global_config</span><span class="p">,</span>
                 <span class="n">data</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">requirements</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        stations: list</span>
<span class="sd">            The list of stations to process</span>
<span class="sd">        config: dict</span>
<span class="sd">            The configuration of the experiment</span>
<span class="sd">        project_config: dict</span>
<span class="sd">            The configuration of the underlying project</span>
<span class="sd">        global_config: dict</span>
<span class="sd">            The global configuration</span>
<span class="sd">        data: pandas.DataFrame</span>
<span class="sd">            The data to use. If None, use the :meth:`setup` method</span>
<span class="sd">        requirements: list of :class:`TaskBase` instances</span>
<span class="sd">            The required instances. If None, you must call the</span>
<span class="sd">            :meth:`set_requirements` method later</span>

<span class="sd">        Other Parameters</span>
<span class="sd">        ----------------</span>
<span class="sd">        ``*args, **kwargs``</span>
<span class="sd">            The configuration of the task. See the :class:`TaskConfig` for</span>
<span class="sd">            arguments. Note that if you provide ``*args``, you have to provide</span>
<span class="sd">            all possible arguments</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">global_config</span> <span class="o">=</span> <span class="n">global_config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project_config</span> <span class="o">=</span> <span class="n">project_config</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">task_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_config</span><span class="o">.</span><span class="n">_make</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default_config</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">task_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_config</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stations</span> <span class="o">=</span> <span class="n">stations</span>
        <span class="c1"># overwrite the class attribute of the formatoptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fmt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fmt</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_datafile</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_datafile</span><span class="p">))]</span>

        <span class="k">if</span> <span class="n">requirements</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_requirements</span> <span class="o">=</span> <span class="n">requirements</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_config</span><span class="o">.</span><span class="n">remove</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">datafile</span> <span class="ow">in</span> <span class="n">safe_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datafile</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">osp</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">datafile</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Removing </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">datafile</span><span class="p">)</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">datafile</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__reduce__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;remove&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_config</span><span class="o">.</span><span class="n">_fields</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_config</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">remove</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_config</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">chain</span><span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stations</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_config</span><span class="p">,</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_requirements</span><span class="p">),</span> <span class="n">config</span><span class="p">))</span>

    <span class="n">docstrings</span><span class="o">.</span><span class="n">delete_params</span><span class="p">(</span>
        <span class="s1">&#39;TaskBase.parameters&#39;</span><span class="p">,</span> <span class="s1">&#39;config&#39;</span><span class="p">,</span> <span class="s1">&#39;project_config&#39;</span><span class="p">,</span> <span class="s1">&#39;global_config&#39;</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="nd">@docstrings.dedent</span>
<div class="viewcode-block" id="TaskBase.from_organizer"><a class="viewcode-back" href="../../api/gwgen.utils.html#gwgen.utils.TaskBase.from_organizer">[docs]</a>    <span class="k">def</span> <span class="nf">from_organizer</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">organizer</span><span class="p">,</span> <span class="n">stations</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a new instance from a :class:`model_organization.ModelOrganizer`</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        organizer: model_organization.ModelOrganizer</span>
<span class="sd">            The organizer to use the configuration from</span>
<span class="sd">        %(TaskBase.parameters.no_config|project_config|global_config)s</span>

<span class="sd">        Other Parameters</span>
<span class="sd">        ----------------</span>
<span class="sd">        %(TaskBase.other_parameters)s</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        TaskBase</span>
<span class="sd">            An instance of the calling class</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">stations</span><span class="p">,</span> <span class="n">organizer</span><span class="o">.</span><span class="n">exp_config</span><span class="p">,</span> <span class="n">organizer</span><span class="o">.</span><span class="n">project_config</span><span class="p">,</span>
                   <span class="n">organizer</span><span class="o">.</span><span class="n">global_config</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    <span class="n">docstrings</span><span class="o">.</span><span class="n">delete_params</span><span class="p">(</span>
        <span class="s1">&#39;TaskBase.parameters&#39;</span><span class="p">,</span> <span class="s1">&#39;stations&#39;</span><span class="p">,</span> <span class="s1">&#39;config&#39;</span><span class="p">,</span> <span class="s1">&#39;project_config&#39;</span><span class="p">,</span>
        <span class="s1">&#39;global_config&#39;</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="nd">@docstrings.get_summaryf</span><span class="p">(</span><span class="s1">&#39;TaskBase.from_task&#39;</span><span class="p">)</span>
    <span class="nd">@docstrings.get_sectionsf</span><span class="p">(</span><span class="s1">&#39;TaskBase.from_task&#39;</span><span class="p">)</span>
    <span class="nd">@docstrings.dedent</span>
<div class="viewcode-block" id="TaskBase.from_task"><a class="viewcode-back" href="../../api/gwgen.utils.html#gwgen.utils.TaskBase.from_task">[docs]</a>    <span class="k">def</span> <span class="nf">from_task</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a new instance from another task</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        task: TaskBase</span>
<span class="sd">            The organizer to use the configuration from. Note that it can also</span>
<span class="sd">            be of a different type than this class</span>
<span class="sd">        %(TaskBase.parameters.no_stations|config|project_config|global_config)s</span>

<span class="sd">        Other Parameters</span>
<span class="sd">        ----------------</span>
<span class="sd">        %(TaskBase.other_parameters)s</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        setup_from_instances: To combine multiple instances of the class</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">stations</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">project_config</span><span class="p">,</span>
                   <span class="n">task</span><span class="o">.</span><span class="n">global_config</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="TaskBase.set_requirements"><a class="viewcode-back" href="../../api/gwgen.utils.html#gwgen.utils.TaskBase.set_requirements">[docs]</a>    <span class="k">def</span> <span class="nf">set_requirements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">requirements</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the requirements for this task</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        requirements: list of :class:`TaskBase` instances</span>
<span class="sd">            The tasks as specified in the :attr:`setup_requires` attribute&quot;&quot;&quot;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">requirements</span><span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_requirements</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_requirements</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">d</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
        <span class="n">missing</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setup_requires</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_from</span> <span class="o">==</span> <span class="s1">&#39;scratch&#39;</span> <span class="ow">and</span> <span class="n">missing</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Missing requirements </span><span class="si">%s</span><span class="s2"> for </span><span class="si">%s</span><span class="s2"> task!&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_requirements</span> <span class="o">=</span> <span class="n">d</span></div>

    <span class="k">def</span> <span class="nf">_get_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datafile</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">osp</span><span class="o">.</span><span class="n">exists</span><span class="p">,</span> <span class="n">safe_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datafile</span><span class="p">))):</span>
            <span class="k">return</span> <span class="s1">&#39;file&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbname</span><span class="p">:</span>
            <span class="n">engine</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span>
            <span class="k">if</span> <span class="n">engine</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span>
                    <span class="n">engine</span><span class="o">.</span><span class="n">has_table</span><span class="p">,</span> <span class="n">safe_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbname</span><span class="p">))):</span>
                <span class="k">return</span> <span class="s1">&#39;db&#39;</span>
        <span class="k">return</span> <span class="s1">&#39;scratch&#39;</span>

    <span class="nd">@docstrings.get_sectionsf</span><span class="p">(</span><span class="s1">&#39;TaskBase._setup_or_init&#39;</span><span class="p">)</span>
    <span class="nd">@docstrings.dedent</span>
    <span class="k">def</span> <span class="nf">_setup_or_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to initialize or setup the data of a task</span>

<span class="sd">        This method is called by :meth:`setup` and :meth:`init_task` and</span>
<span class="sd">        calls :meth:`setup_from_file`, :meth:`setup_from_db` and</span>
<span class="sd">        :meth:`setup_from_scratch` (or the corresponding `init` method)</span>
<span class="sd">        depending  on :attr:`setup_from`</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        method: { &#39;setup&#39; | &#39;init&#39; }</span>
<span class="sd">            The methods to call. If method is ``&#39;setup&#39;``, the (depending on</span>
<span class="sd">            :attr:`setup_from`), e.g. the :meth:`setup_from_scratch` is called,</span>
<span class="sd">            otherwise (e.g.) the :meth:`init_from_scratch` method is called</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_requires</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_requirements</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;set_requirements method has not been called!&#39;</span><span class="p">)</span>
        <span class="n">setup_from</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_from</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> from </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">setup_from</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span> <span class="o">+</span> <span class="s1">&#39;_from_&#39;</span> <span class="o">+</span> <span class="n">setup_from</span><span class="p">)()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Done.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="nd">@docstrings.dedent</span>
<div class="viewcode-block" id="TaskBase.init_task"><a class="viewcode-back" href="../../api/gwgen.utils.html#gwgen.utils.TaskBase.init_task">[docs]</a>    <span class="k">def</span> <span class="nf">init_task</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method that is called on the I/O-Processor to initialize the setup&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup_or_init</span><span class="p">(</span><span class="s1">&#39;init&#39;</span><span class="p">)</span></div>

    <span class="nd">@docstrings.dedent</span>
<div class="viewcode-block" id="TaskBase.setup"><a class="viewcode-back" href="../../api/gwgen.utils.html#gwgen.utils.TaskBase.setup">[docs]</a>    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set up the database for this task</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Thread</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup_or_init</span><span class="p">(</span><span class="s1">&#39;setup&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_config</span><span class="o">.</span><span class="n">to_csv</span><span class="p">:</span>
            <span class="n">thread</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">write2file</span><span class="p">)</span>
            <span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thread</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_config</span><span class="o">.</span><span class="n">to_db</span><span class="p">:</span>
            <span class="n">thread</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">write2db</span><span class="p">)</span>
            <span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thread</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span></div>

    <span class="k">def</span> <span class="nf">_split_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kws</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convenience method to return the keywords for each data file</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        kws: dict</span>
<span class="sd">            A mapping whose values correspond to the shape of the</span>
<span class="sd">            :attr:`_datafile` attribute. I.e. if there are two data files,</span>
<span class="sd">            then all the values in `kws` must be lists of length 2. If the</span>
<span class="sd">            :attr:`_datafile` attribute is a string, then we don&#39;t expect any</span>
<span class="sd">            list</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list of dict</span>
<span class="sd">            The splitted `kws`&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_datafile</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">kws</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">[{</span><span class="n">key</span><span class="p">:</span> <span class="n">val</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">kws</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_datafile</span><span class="p">))]</span>

    <span class="k">def</span> <span class="nf">_get_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the data at position `i`</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        i: int</span>
<span class="sd">            The integer position where to set the data. If the</span>
<span class="sd">            :attr:`_datafile` attribute is a string, `i` will be ignored.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_datafile</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_set_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the  data at position `i`</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data: pandas.DataFrame</span>
<span class="sd">            The dataframe to set</span>
<span class="sd">        i: int</span>
<span class="sd">            The integer position where to set the data. If the</span>
<span class="sd">            :attr:`_datafile` attribute is a string, `i` will be ignored.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_datafile</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>

<div class="viewcode-block" id="TaskBase.init_from_file"><a class="viewcode-back" href="../../api/gwgen.utils.html#gwgen.utils.TaskBase.init_from_file">[docs]</a>    <span class="k">def</span> <span class="nf">init_from_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize the task from already stored files&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="TaskBase.init_from_db"><a class="viewcode-back" href="../../api/gwgen.utils.html#gwgen.utils.TaskBase.init_from_db">[docs]</a>    <span class="k">def</span> <span class="nf">init_from_db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize the task from datatables already created&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="TaskBase.init_from_scratch"><a class="viewcode-back" href="../../api/gwgen.utils.html#gwgen.utils.TaskBase.init_from_scratch">[docs]</a>    <span class="k">def</span> <span class="nf">init_from_scratch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize the task from the configuration settings&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="TaskBase.setup_from_file"><a class="viewcode-back" href="../../api/gwgen.utils.html#gwgen.utils.TaskBase.setup_from_file">[docs]</a>    <span class="k">def</span> <span class="nf">setup_from_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set up the task from already stored files&quot;&quot;&quot;</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_split_kwargs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">chunksize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;chunksize&#39;</span><span class="p">,</span> <span class="mi">10</span> <span class="o">**</span> <span class="mi">5</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">datafile</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">safe_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datafile</span><span class="p">)):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">all_data</span> <span class="ow">in</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">datafile</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="n">chunksize</span><span class="p">,</span>
                                        <span class="o">**</span><span class="n">kwargs</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                <span class="k">if</span> <span class="s1">&#39;id&#39;</span> <span class="ow">in</span> <span class="n">all_data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">all_data</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">stations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stations</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">all_data</span><span class="o">.</span><span class="n">loc</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="n">stations</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">names</span> <span class="o">=</span> <span class="n">all_data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span>
                    <span class="n">axis</span> <span class="o">=</span> <span class="n">names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">axis</span><span class="p">)]</span> <span class="o">+</span> <span class="p">[</span><span class="n">stations</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span>
                        <span class="nb">slice</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">all_data</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">key</span><span class="p">)])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_data</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">i</span><span class="p">)</span></div>

<div class="viewcode-block" id="TaskBase.setup_from_db"><a class="viewcode-back" href="../../api/gwgen.utils.html#gwgen.utils.TaskBase.setup_from_db">[docs]</a>    <span class="k">def</span> <span class="nf">setup_from_db</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set up the task from datatables already created&quot;&quot;&quot;</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_split_kwargs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">dbname</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">safe_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbname</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_data</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span>
                <span class="s2">&quot;SELECT * FROM </span><span class="si">%s</span><span class="s2"> WHERE id IN (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">dbname</span><span class="p">,</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="s2">&quot;&#39;{0}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stations</span><span class="p">))),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">i</span><span class="p">)</span></div>

    <span class="nd">@classmethod</span>
    <span class="nd">@docstrings.get_sectionsf</span><span class="p">(</span><span class="s1">&#39;TaskBase.setup_from_instances&#39;</span><span class="p">)</span>
    <span class="nd">@docstrings.dedent</span>
<div class="viewcode-block" id="TaskBase.setup_from_instances"><a class="viewcode-back" href="../../api/gwgen.utils.html#gwgen.utils.TaskBase.setup_from_instances">[docs]</a>    <span class="k">def</span> <span class="nf">setup_from_instances</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">instances</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Combine multiple task instances into one instance</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        base: TaskBase</span>
<span class="sd">            The base task to use the configuration from</span>
<span class="sd">        instances: list of :class:`TaskBase`</span>
<span class="sd">            The tasks containing the data</span>
<span class="sd">        copy: bool</span>
<span class="sd">            If True, a copy of `base` is returned, otherwise `base` is</span>
<span class="sd">            modified inplace&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">copy</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">copy</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">base</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Setting up from </span><span class="si">%i</span><span class="s1"> instances&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">instances</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_datafile</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">ini</span><span class="o">.</span><span class="n">data</span> <span class="k">for</span> <span class="n">ini</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">ini</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">ini</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_datafile</span><span class="p">))]</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">stations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ini</span><span class="o">.</span><span class="n">stations</span> <span class="k">for</span> <span class="n">ini</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">))</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="k">return</span> <span class="n">obj</span></div>

    <span class="nd">@abc.abstractmethod</span>
<div class="viewcode-block" id="TaskBase.setup_from_scratch"><a class="viewcode-back" href="../../api/gwgen.utils.html#gwgen.utils.TaskBase.setup_from_scratch">[docs]</a>    <span class="k">def</span> <span class="nf">setup_from_scratch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Setup the data from the configuration settings&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

    <span class="nd">@docstrings.get_sectionsf</span><span class="p">(</span><span class="s1">&#39;Parameterizer.run&#39;</span><span class="p">,</span>
                              <span class="n">sections</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Parameters&#39;</span><span class="p">,</span> <span class="s1">&#39;Returns&#39;</span><span class="p">])</span>
    <span class="nd">@docstrings.dedent</span>
<div class="viewcode-block" id="TaskBase.run"><a class="viewcode-back" href="../../api/gwgen.utils.html#gwgen.utils.TaskBase.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run the task</span>

<span class="sd">        This method uses the data that has been setup through the :meth:`setup`</span>
<span class="sd">        method to process some configuration</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dict</span>
<span class="sd">            The dictionary with the configuration settings for the namelist</span>
<span class="sd">        dict</span>
<span class="sd">            The dictionary holding additional meta information&quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">xarray</span> <span class="kn">as</span> <span class="nn">xr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Calculating </span><span class="si">%s</span><span class="s1"> task&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># ---- file names</span>
        <span class="n">nc_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_config</span><span class="o">.</span><span class="n">nc_output</span>
        <span class="n">plot_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_config</span><span class="o">.</span><span class="n">plot_output</span>
        <span class="n">project_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_config</span><span class="o">.</span><span class="n">project_output</span>
        <span class="n">info</span><span class="p">[</span><span class="s1">&#39;nc_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nc_output</span>
        <span class="n">info</span><span class="p">[</span><span class="s1">&#39;plot_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plot_output</span>
        <span class="n">info</span><span class="p">[</span><span class="s1">&#39;project_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">project_output</span>

        <span class="c1"># ---- open dataset</span>
        <span class="n">ds_orig</span> <span class="o">=</span> <span class="n">ds_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ds_list</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">):</span>
            <span class="n">ds_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ds_list</span><span class="p">]</span>

        <span class="c1"># ---- create project</span>
        <span class="n">inproject</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_config</span><span class="o">.</span><span class="n">project</span> <span class="ow">or</span> <span class="n">project_output</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_config</span><span class="o">.</span><span class="n">new_project</span> <span class="ow">and</span> <span class="n">osp</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">inproject</span><span class="p">):</span>
            <span class="kn">import</span> <span class="nn">psyplot.project</span> <span class="kn">as</span> <span class="nn">psy</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;    Loading existing project </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">inproject</span><span class="p">)</span>
            <span class="n">sp</span> <span class="o">=</span> <span class="n">psy</span><span class="o">.</span><span class="n">Project</span><span class="o">.</span><span class="n">load_project</span><span class="p">(</span><span class="n">inproject</span><span class="p">,</span> <span class="n">datasets</span><span class="o">=</span><span class="n">ds_list</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;    Creating project...&#39;</span><span class="p">)</span>
            <span class="n">sp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_project</span><span class="p">(</span><span class="n">ds_orig</span><span class="p">)</span>

        <span class="c1"># ---- save data and project</span>
        <span class="n">pdf</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">plot_output</span><span class="p">,</span> <span class="n">tight</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">close_pdf</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">project_output</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;    Saving project to </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">project_output</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nc_output</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">safe_list</span><span class="p">(</span><span class="n">nc_output</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">osp</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="n">save_kws</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">use_rel_paths</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">paths</span><span class="o">=</span><span class="n">safe_list</span><span class="p">(</span><span class="n">nc_output</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># save the entire dataset into the pickle file</span>
                <span class="n">save_kws</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">ds_description</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;ds&#39;</span><span class="p">})</span>
            <span class="n">sp</span><span class="o">.</span><span class="n">save_project</span><span class="p">(</span><span class="n">project_output</span><span class="p">,</span> <span class="o">**</span><span class="n">save_kws</span><span class="p">)</span>
        <span class="c1"># ---- make plots not covered by psyplot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_additionals</span><span class="p">(</span><span class="n">pdf</span><span class="p">)</span>

        <span class="c1"># ---- configure the experiment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">make_run_config</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># ---- export the figures</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;    Saving plots to </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">plot_output</span><span class="p">)</span>
        <span class="n">pdf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># ---- close the project</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_config</span><span class="o">.</span><span class="n">close</span><span class="p">:</span>
            <span class="n">sp</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Done.&#39;</span><span class="p">)</span></div>

    <span class="nd">@docstrings.get_sectionsf</span><span class="p">(</span><span class="s1">&#39;TaskBase.create_project&#39;</span><span class="p">)</span>
    <span class="nd">@docstrings.dedent</span>
<div class="viewcode-block" id="TaskBase.create_project"><a class="viewcode-back" href="../../api/gwgen.utils.html#gwgen.utils.TaskBase.create_project">[docs]</a>    <span class="k">def</span> <span class="nf">create_project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        To be reimplemented for each task with :attr:`has_run`</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ds: xarray.Dataset</span>
<span class="sd">            The dataset to plot&quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">psyplot.project</span> <span class="kn">as</span> <span class="nn">psy</span>
        <span class="k">return</span> <span class="n">psy</span><span class="o">.</span><span class="n">gcp</span><span class="p">()</span></div>

    <span class="nd">@docstrings.get_sectionsf</span><span class="p">(</span><span class="s1">&#39;TaskBase.make_run_config&#39;</span><span class="p">)</span>
    <span class="nd">@docstrings.dedent</span>
<div class="viewcode-block" id="TaskBase.make_run_config"><a class="viewcode-back" href="../../api/gwgen.utils.html#gwgen.utils.TaskBase.make_run_config">[docs]</a>    <span class="k">def</span> <span class="nf">make_run_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to be reimplemented for each task with :attr:`has_run`</span>
<span class="sd">        to manipulate the configuration</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sp: psyplot.project.Project</span>
<span class="sd">            The project of the data</span>
<span class="sd">        info: dict</span>
<span class="sd">            The dictionary for saving additional information of the task&quot;&quot;&quot;</span>
        <span class="k">return</span></div>

    <span class="nd">@docstrings.get_sectionsf</span><span class="p">(</span><span class="s1">&#39;TaskBase.plot_additionals&#39;</span><span class="p">)</span>
    <span class="nd">@docstrings.dedent</span>
<div class="viewcode-block" id="TaskBase.plot_additionals"><a class="viewcode-back" href="../../api/gwgen.utils.html#gwgen.utils.TaskBase.plot_additionals">[docs]</a>    <span class="k">def</span> <span class="nf">plot_additionals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pdf</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to be reimplemented to make additional plots (if necessary)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pdf: matplotlib.backends.backend_pdf.PdfPages</span>
<span class="sd">            The PdfPages instance which can be used to save the figure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_modify_parser</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">parser</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Classmethod to modify the arguments of a command line parser</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        parser: gwgen.main.FuncArgParser</span>
<span class="sd">            The :class:`argparse.ArgumentParser` instance that holds the</span>
<span class="sd">            arguments from the :meth:`run` method</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        gwgen.main.FuncArgParser</span>
<span class="sd">            The above `parser`</span>
<span class="sd">        setup_grp</span>
<span class="sd">            The argument group for the setup method</span>
<span class="sd">        run_grp</span>
<span class="sd">            The argument group for the run method&quot;&quot;&quot;</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">setup_args</span><span class="p">(</span><span class="n">default_config</span><span class="p">)</span>

        <span class="n">setup_grp</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span>
            <span class="s1">&#39;Setup arguments&#39;</span><span class="p">,</span> <span class="s1">&#39;Arguments affecting the setup of the data&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">_SetupConfig</span><span class="o">.</span><span class="n">_fields</span><span class="p">:</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">update_arg</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">setup_grp</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">update_arg</span><span class="p">(</span><span class="s1">&#39;setup_from&#39;</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="nb">long</span><span class="o">=</span><span class="s1">&#39;from&#39;</span><span class="p">,</span>
                          <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;scratch&#39;</span><span class="p">,</span> <span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="s1">&#39;db&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">cls</span><span class="o">.</span><span class="n">dbname</span><span class="p">:</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">pop_arg</span><span class="p">(</span><span class="s1">&#39;to_db&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_datafile</span><span class="p">:</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">pop_arg</span><span class="p">(</span><span class="s1">&#39;to_csv&#39;</span><span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">pop_arg</span><span class="p">(</span><span class="s1">&#39;remove&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">update_arg</span><span class="p">(</span><span class="s1">&#39;remove&#39;</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="s1">&#39;rm&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">cls</span><span class="o">.</span><span class="n">has_run</span><span class="p">:</span>
            <span class="n">run_grp</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">_RunConfig</span><span class="o">.</span><span class="n">_fields</span><span class="p">:</span>
                <span class="n">parser</span><span class="o">.</span><span class="n">pop_arg</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">run_grp</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span>
                <span class="s1">&#39;Run arguments&#39;</span><span class="p">,</span> <span class="s1">&#39;Arguments for the experiment configuration&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">_RunConfig</span><span class="o">.</span><span class="n">_fields</span><span class="p">:</span>
                <span class="n">parser</span><span class="o">.</span><span class="n">update_arg</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">run_grp</span><span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">update_arg</span><span class="p">(</span><span class="s1">&#39;plot_output&#39;</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">update_arg</span><span class="p">(</span><span class="s1">&#39;nc_output&#39;</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="s1">&#39;onc&#39;</span><span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">update_arg</span><span class="p">(</span><span class="s1">&#39;project_output&#39;</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="s1">&#39;op&#39;</span><span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">update_arg</span><span class="p">(</span><span class="s1">&#39;new_project&#39;</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="s1">&#39;np&#39;</span><span class="p">)</span>
            <span class="c1"># XXX Bug fix until docstrings.keep_params works right XXX</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">pop_key</span><span class="p">(</span><span class="s1">&#39;project&#39;</span><span class="p">,</span> <span class="s1">&#39;action&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="c1"># XXX</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">update_arg</span><span class="p">(</span><span class="s1">&#39;project&#39;</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="s1">&#39;p&#39;</span><span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">pop_arg</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">parser</span><span class="p">,</span> <span class="n">setup_grp</span><span class="p">,</span> <span class="n">run_grp</span>

<div class="viewcode-block" id="TaskBase.get_run_kws"><a class="viewcode-back" href="../../api/gwgen.utils.html#gwgen.utils.TaskBase.get_run_kws">[docs]</a>    <span class="k">def</span> <span class="nf">get_run_kws</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">val</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getargspec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">)[</span><span class="mi">0</span><span class="p">]}</span></div>

<div class="viewcode-block" id="TaskBase.write2db"><a class="viewcode-back" href="../../api/gwgen.utils.html#gwgen.utils.TaskBase.write2db">[docs]</a>    <span class="k">def</span> <span class="nf">write2db</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write the data from this task to the database given by the</span>
<span class="sd">        :attr:`engine` attribute&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">dbname</span><span class="p">,</span> <span class="n">kws</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span>
                <span class="n">safe_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbname</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_split_kwargs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_split_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sql_dtypes</span><span class="p">))):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_data</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="s1">&#39;id&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
            <span class="n">df_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">chain</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span><span class="p">))</span>
            <span class="n">missing</span> <span class="o">=</span> <span class="n">df_names</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;No data type was specified for </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">missing</span><span class="p">)</span>
                <span class="n">dtype</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_names</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dtype</span><span class="p">):</span>
                    <span class="n">dtype</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">dtype</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">df_names</span><span class="p">}</span>
                <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;dtype&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
            <span class="n">lock</span> <span class="o">=</span> <span class="n">_db_locks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dbname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">lock</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Acquiring lock...&#39;</span><span class="p">)</span>
                <span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Writing </span><span class="si">%s</span><span class="s1"> lines to data table </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>
                             <span class="n">dbname</span><span class="p">)</span>
            <span class="n">kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;if_exists&#39;</span><span class="p">,</span> <span class="s1">&#39;append&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">data</span><span class="o">.</span><span class="n">to_sql</span><span class="p">(</span><span class="n">dbname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">lock</span><span class="p">:</span>
                    <span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Done&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TaskBase.write2file"><a class="viewcode-back" href="../../api/gwgen.utils.html#gwgen.utils.TaskBase.write2file">[docs]</a>    <span class="k">def</span> <span class="nf">write2file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write the database to the :attr:`datafile` file&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">datafile</span><span class="p">,</span> <span class="n">kws</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">safe_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datafile</span><span class="p">),</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">_split_kwargs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">))):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_data</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">lock</span> <span class="o">=</span> <span class="n">_file_locks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">datafile</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">lock</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Acquiring lock...&#39;</span><span class="p">)</span>
                <span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
            <span class="n">exists</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">datafile</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Writing data to </span><span class="si">%s</span><span class="s1">existing file </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;not &#39;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">datafile</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">safe_csv_append</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">datafile</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">lock</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Release lock&#39;</span><span class="p">)</span>
                    <span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Done&#39;</span><span class="p">)</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="TaskBase.get_manager"><a class="viewcode-back" href="../../api/gwgen.utils.html#gwgen.utils.TaskBase.get_manager">[docs]</a>    <span class="k">def</span> <span class="nf">get_manager</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a manager of this class that can be used to setup and organize</span>
<span class="sd">        tasks&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">TaskManager</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="TaskManager"><a class="viewcode-back" href="../../api/gwgen.utils.html#gwgen.utils.TaskManager">[docs]</a><span class="k">class</span> <span class="nc">TaskManager</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A manager to run the tasks within a task framework&quot;&quot;&quot;</span>

    <span class="c1">#: A subclass of the :class:`TaskBase` class whose</span>
    <span class="c1">#: :attr:`TaskBase._registry` attribute shall be used</span>
    <span class="n">base_task</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="n">docstrings</span><span class="o">.</span><span class="n">keep_params</span><span class="p">(</span><span class="s1">&#39;TaskBase.parameters&#39;</span><span class="p">,</span> <span class="s1">&#39;stations&#39;</span><span class="p">,</span> <span class="s1">&#39;logger&#39;</span><span class="p">)</span>

    <span class="n">_logger</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">logger</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The logger of this task&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span>

    <span class="nd">@logger.setter</span>
    <span class="k">def</span> <span class="nf">logger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;serial&#39;</span><span class="p">):</span>
            <span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="kn">as</span> <span class="nn">mp</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="p">[</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                 <span class="n">mp</span><span class="o">.</span><span class="n">current_process</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="p">[</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@docstrings.dedent</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_task</span><span class="o">=</span><span class="n">TaskBase</span><span class="p">,</span> <span class="n">tasks</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="p">{}):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        base_task: TaskBase</span>
<span class="sd">            A subclass of the :class:`TaskBase` class whose tasks shall be</span>
<span class="sd">            used within this manager.</span>
<span class="sd">        tasks: list of :class:`TaskBase` instances</span>
<span class="sd">            The initialized tasks to use. If None, you need to call the</span>
<span class="sd">            :meth:`initialize_tasks` method</span>
<span class="sd">        config: dict</span>
<span class="sd">            The configuration of this manager containing information about the</span>
<span class="sd">            multiprocessing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_task</span> <span class="o">=</span> <span class="n">base_task</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span> <span class="o">=</span> <span class="n">tasks</span>

    <span class="k">def</span> <span class="nf">__reduce__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_task</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>

    <span class="nd">@docstrings.get_sectionsf</span><span class="p">(</span><span class="s1">&#39;TaskManager._get_tasks&#39;</span><span class="p">)</span>
    <span class="nd">@docstrings.dedent</span>
    <span class="k">def</span> <span class="nf">_get_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stations</span><span class="p">,</span> <span class="n">task_kws</span><span class="o">=</span><span class="p">{}):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initaliaze the tasks</span>

<span class="sd">        This classmethod uses the :class:`TaskBase` framework to</span>
<span class="sd">        initialize the parameterization tasks</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        %(TaskBase.parameters.stations|logger)s</span>
<span class="sd">        task_kws: dict</span>
<span class="sd">            Keywords can be valid identifiers of the :class:`TaskBase`</span>
<span class="sd">            instances, dictionaries may be mappings for their</span>
<span class="sd">            :meth:`~TaskBase.setup` method</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            A list of :class:`TaskBase` instances&quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">init_task</span><span class="p">(</span><span class="n">task</span><span class="p">):</span>
            <span class="n">kws</span> <span class="o">=</span> <span class="n">task_kws</span><span class="p">[</span><span class="n">task</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">kws</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;config&#39;</span><span class="p">)</span>
            <span class="n">project_config</span> <span class="o">=</span> <span class="n">kws</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;project_config&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">task</span><span class="p">(</span><span class="n">stations</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">project_config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">)</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="p">{</span><span class="n">task</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">init_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_task_cls</span><span class="p">,</span> <span class="n">task_kws</span><span class="p">)}</span>
        <span class="n">task_kws</span> <span class="o">=</span> <span class="n">task_kws</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># insert the requirements</span>
        <span class="n">checked_requirements</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">checked_requirements</span><span class="p">:</span>
            <span class="n">checked_requirements</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">setup_from</span> <span class="o">==</span> <span class="s1">&#39;scratch&#39;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">req_task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_requirements</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">req_task</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">:</span>
                            <span class="n">checked_requirements</span> <span class="o">=</span> <span class="bp">False</span>
                            <span class="n">tasks</span><span class="p">[</span><span class="n">req_task</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">req_task</span><span class="o">.</span><span class="n">from_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
        <span class="c1"># sort the tasks for their requirements</span>
        <span class="n">sorted_tasks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sort_by_requirement</span><span class="p">(</span><span class="n">tasks</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">instance</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sorted_tasks</span><span class="p">):</span>
            <span class="n">requirements</span> <span class="o">=</span> <span class="p">[</span><span class="n">ini</span> <span class="k">for</span> <span class="n">ini</span> <span class="ow">in</span> <span class="n">sorted_tasks</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">ini</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">instance</span><span class="o">.</span><span class="n">setup_requires</span><span class="p">]</span>
            <span class="n">instance</span><span class="o">.</span><span class="n">set_requirements</span><span class="p">(</span><span class="n">requirements</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sorted_tasks</span>

    <span class="nd">@docstrings.dedent</span>
<div class="viewcode-block" id="TaskManager.initialize_tasks"><a class="viewcode-back" href="../../api/gwgen.utils.html#gwgen.utils.TaskManager.initialize_tasks">[docs]</a>    <span class="k">def</span> <span class="nf">initialize_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stations</span><span class="p">,</span> <span class="n">task_kws</span><span class="o">=</span><span class="p">{}):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the setup of the tasks</span>

<span class="sd">        This classmethod uses the :class:`TaskBase` framework to</span>
<span class="sd">        initialize the setup on the I/O-processor</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        %(TaskManager._get_tasks.parameters)s&quot;&quot;&quot;</span>
        <span class="n">task_kws</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">val</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">task_kws</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="n">stations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">stations</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">stations</span><span class="o">.</span><span class="n">ndim</span><span class="p">:</span>
            <span class="n">stations</span> <span class="o">=</span> <span class="n">stations</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># sort the tasks for their requirements</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span> <span class="o">=</span> <span class="n">tasks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_tasks</span><span class="p">(</span><span class="n">stations</span><span class="p">,</span> <span class="n">task_kws</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">:</span>
            <span class="n">instance</span><span class="o">.</span><span class="n">init_task</span><span class="p">()</span></div>

<div class="viewcode-block" id="TaskManager.get_task"><a class="viewcode-back" href="../../api/gwgen.utils.html#gwgen.utils.TaskManager.get_task">[docs]</a>    <span class="k">def</span> <span class="nf">get_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the task corresponding in this manager of `identifier`</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        identifier: str</span>
<span class="sd">            The :attr:`name` attribute of the :class:`TaskBase` subclass</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        TaskBase</span>
<span class="sd">            The requested task&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">next</span><span class="p">(</span>
                <span class="n">task</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span> <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">identifier</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
                <span class="s1">&#39;Manager has no task {}. Possibilities: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">identifier</span><span class="p">,</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">)))</span></div>

<div class="viewcode-block" id="TaskManager.get_task_cls"><a class="viewcode-back" href="../../api/gwgen.utils.html#gwgen.utils.TaskManager.get_task_cls">[docs]</a>    <span class="k">def</span> <span class="nf">get_task_cls</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the task class corresponding to the given `identifier`</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        identifier: str</span>
<span class="sd">            The :attr:`name` attribute of the :class:`TaskBase` subclass</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        TaskBase</span>
<span class="sd">            The class of the requested task&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">next</span><span class="p">(</span>
                <span class="n">task_cls</span> <span class="k">for</span> <span class="n">task_cls</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_task</span><span class="o">.</span><span class="n">_registry</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">task_cls</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">identifier</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;Unkown task {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">identifier</span><span class="p">))</span></div>

<div class="viewcode-block" id="TaskManager.get_requirements"><a class="viewcode-back" href="../../api/gwgen.utils.html#gwgen.utils.TaskManager.get_requirements">[docs]</a>    <span class="k">def</span> <span class="nf">get_requirements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">all_requirements</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the required task classes for this task</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        identifier: str</span>
<span class="sd">            The :attr:`name` attribute of the :class:`Parameterizer` subclass</span>
<span class="sd">        all_requirements: bool</span>
<span class="sd">            If True, all requirements are searched recursively. Otherwise only</span>
<span class="sd">            the direct requirements are returned</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list of :class:`Parameterizer`</span>
<span class="sd">            A list of Parameterizer subclasses that are required for the task</span>
<span class="sd">            of the given `identifier`&quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">get_requirements</span><span class="p">(</span><span class="n">task_cls</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="n">task_cls</span><span class="o">.</span><span class="n">setup_requires</span><span class="p">:</span>
                <span class="n">req_cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_task_cls</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">req_cls</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">all_requirements</span><span class="p">:</span>
                    <span class="n">get_requirements</span><span class="p">(</span><span class="n">req_cls</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">get_requirements</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_task_cls</span><span class="p">(</span><span class="n">identifier</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">ret</span></div>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="TaskManager.sort_by_requirement"><a class="viewcode-back" href="../../api/gwgen.utils.html#gwgen.utils.TaskManager.sort_by_requirement">[docs]</a>    <span class="k">def</span> <span class="nf">sort_by_requirement</span><span class="p">(</span><span class="n">objects</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sort the given tasks by their logical order</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        objects: list of :class:`TaskBase` subclasses or instances</span>
<span class="sd">            The objects to sort</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list of :class:`TaskBase` subclasses or instances</span>
<span class="sd">            The same as `objects` but sorted&quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">get_requirements</span><span class="p">(</span><span class="n">current</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">remaining</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">current</span><span class="o">.</span><span class="n">setup_requires</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">remaining</span><span class="p">:</span>
                    <span class="n">get_requirements</span><span class="p">(</span><span class="n">remaining</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current</span><span class="p">)</span>
        <span class="n">remaining</span> <span class="o">=</span> <span class="p">{</span><span class="n">task</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">task</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">objects</span><span class="p">}</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="n">remaining</span><span class="p">:</span>
            <span class="n">get_requirements</span><span class="p">(</span><span class="n">remaining</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">remaining</span><span class="p">))))</span>
        <span class="k">return</span> <span class="n">ret</span></div>

    <span class="nd">@docstrings.get_sectionsf</span><span class="p">(</span><span class="s1">&#39;TaskManager.setup&#39;</span><span class="p">,</span> <span class="n">sections</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Parameters&#39;</span><span class="p">,</span>
                                                             <span class="s1">&#39;Returns&#39;</span><span class="p">])</span>
<div class="viewcode-block" id="TaskManager.setup"><a class="viewcode-back" href="../../api/gwgen.utils.html#gwgen.utils.TaskManager.setup">[docs]</a>    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stations</span><span class="p">,</span> <span class="n">to_return</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Setup the data for the tasks in parallel or serial</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        stations: list of str</span>
<span class="sd">            The stations to process</span>
<span class="sd">        to_return: list of str</span>
<span class="sd">            The names of the tasks to return. If None, all tasks that have a</span>
<span class="sd">            run method will be returned</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>
        <span class="n">stations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">stations</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">stations</span><span class="o">.</span><span class="n">ndim</span><span class="p">:</span>
            <span class="n">stations</span> <span class="o">=</span> <span class="n">stations</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">to_return</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">to_return</span> <span class="o">=</span> <span class="p">[</span><span class="n">task</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span> <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">has_run</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">to_return</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="n">to_return</span> <span class="o">=</span> <span class="p">[</span><span class="n">task</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">to_return</span> <span class="o">=</span> <span class="n">safe_list</span><span class="p">(</span><span class="n">to_return</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;serial&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup_parallel</span><span class="p">(</span><span class="n">stations</span><span class="p">,</span> <span class="n">to_return</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># serial processing</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup</span><span class="p">(</span>
                <span class="n">stations</span><span class="o">=</span><span class="n">stations</span><span class="p">,</span> <span class="n">to_return</span><span class="o">=</span><span class="n">to_return</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_setup_parallel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stations</span><span class="p">,</span> <span class="n">to_return</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Setup the data for the tasks in parallel</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        %(TaskManager.setup.parameters)s</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            A list of :class:`Parameterizer` instances specified in `to_return`</span>
<span class="sd">            that hold the data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span>
        <span class="n">scheduler</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;scheduler&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scheduler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">distributed</span> <span class="kn">import</span> <span class="n">Client</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">scheduler</span><span class="p">,</span> <span class="p">)</span> <span class="k">if</span> <span class="n">scheduler</span> <span class="k">else</span> <span class="p">()</span>
            <span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
            <span class="n">lock_dir</span> <span class="o">=</span> <span class="n">mkdtemp</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;tmp_gwgen_locks_&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Temporary lock directory: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">lock_dir</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="kn">as</span> <span class="nn">mp</span>
        <span class="n">all_tasks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span>
        <span class="n">grouped</span> <span class="o">=</span> <span class="p">[(</span><span class="n">key</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">tasks</span><span class="p">))</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">tasks</span> <span class="ow">in</span> <span class="n">groupby</span><span class="p">(</span>
                       <span class="n">all_tasks</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">task</span><span class="p">:</span> <span class="n">task</span><span class="o">.</span><span class="n">setup_parallel</span><span class="p">)]</span>
        <span class="n">ret_tasks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">orig_stations</span> <span class="o">=</span> <span class="n">stations</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">tasks</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">grouped</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span> <span class="o">=</span> <span class="n">tasks</span>
            <span class="k">if</span> <span class="n">key</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Processing </span><span class="si">%s</span><span class="s1"> tasks in parallel&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tasks</span><span class="p">))</span>
                <span class="c1"># initialize pool</span>
                <span class="n">nprocs</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nprocs&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">nprocs</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">scheduler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="n">nprocs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">client</span><span class="o">.</span><span class="n">ncores</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">nprocs</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>
                <span class="c1"># split up the stations for the workers</span>
                <span class="n">max_stations</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">orig_stations</span><span class="p">)</span> <span class="o">/</span> <span class="n">nprocs</span><span class="p">)),</span>
                                   <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_stations&#39;</span><span class="p">,</span> <span class="mi">500</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">orig_stations</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_stations</span><span class="p">:</span>
                    <span class="n">stations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">orig_stations</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
                        <span class="n">max_stations</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">stations</span><span class="p">),</span> <span class="n">max_stations</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">stations</span> <span class="o">=</span> <span class="p">[</span><span class="n">orig_stations</span><span class="p">]</span>
                <span class="c1"># The real number of stations list. It might happen that we</span>
                <span class="c1"># have more processors than stations which then results in</span>
                <span class="c1"># empty arrays in `stations`</span>
                <span class="n">nstations_lists</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">stations</span><span class="p">)</span>
                                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">stations</span><span class="p">))</span>
                <span class="c1"># make sure we don&#39;t send a list of empty stations to a process</span>
                <span class="n">stations</span> <span class="o">=</span> <span class="n">stations</span><span class="p">[:</span><span class="n">nstations_lists</span><span class="p">]</span>
                <span class="n">nprocs</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">nprocs</span><span class="p">,</span> <span class="n">nstations_lists</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">scheduler</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="c1"># create locks</span>
                    <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">safe_list</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">datafile</span><span class="p">):</span>
                            <span class="n">_file_locks</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
                        <span class="k">for</span> <span class="n">dbname</span> <span class="ow">in</span> <span class="n">safe_list</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">dbname</span><span class="p">):</span>
                            <span class="n">_db_locks</span><span class="p">[</span><span class="n">dbname</span><span class="p">]</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
                    <span class="c1"># start the pool</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s1">&#39;Starting </span><span class="si">%s</span><span class="s1"> processes for </span><span class="si">%s</span><span class="s1"> station lists&#39;</span><span class="p">,</span>
                        <span class="n">nprocs</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">stations</span><span class="p">))</span>
                    <span class="n">pool</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">nprocs</span><span class="p">,</span> <span class="n">initializer</span><span class="o">=</span><span class="n">init_locks</span><span class="p">,</span>
                                   <span class="n">initargs</span><span class="o">=</span><span class="p">(</span><span class="n">_db_locks</span><span class="p">,</span> <span class="n">_file_locks</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">file_locks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="p">(</span>
                        <span class="n">safe_list</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">datafile</span><span class="p">)</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">)))</span>
                    <span class="n">db_locks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="p">(</span>
                        <span class="n">safe_list</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">datafile</span><span class="p">)</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">)))</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">grouped</span><span class="p">):</span>
                    <span class="n">unsafe</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="n">grouped</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]))</span>
                    <span class="n">_to_return</span> <span class="o">=</span> <span class="n">to_return</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="p">(</span>
                        <span class="n">t</span><span class="o">.</span><span class="n">setup_requires</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="n">unsafe</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]))))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">_to_return</span> <span class="o">=</span> <span class="n">to_return</span>
                <span class="n">args</span> <span class="o">=</span> <span class="p">[[</span><span class="n">s</span><span class="p">,</span> <span class="n">_to_return</span><span class="p">,</span> <span class="bp">True</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">stations</span><span class="p">]</span>
                <span class="c1"># start the computation</span>
                <span class="k">if</span> <span class="n">scheduler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">kws</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;workers&#39;</span><span class="p">:</span> <span class="nb">set</span><span class="p">(</span><span class="n">client</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">workers</span><span class="p">[:</span><span class="n">nprocs</span><span class="p">])}</span>
                    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                        <span class="n">kws</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">for</span> <span class="n">proc_args</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
                        <span class="n">proc_args</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">file_locks</span><span class="p">,</span> <span class="n">db_locks</span><span class="p">,</span> <span class="n">lock_dir</span><span class="p">])</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">pure</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">)</span>
                    <span class="n">tasks</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
                    <span class="n">tasks</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                    <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
                    <span class="n">pool</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
                <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">task</span><span class="o">.</span><span class="n">setup_from_instances</span><span class="p">(</span>
                        <span class="nb">next</span><span class="p">(</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">all_tasks</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">task</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
                        <span class="p">[</span><span class="n">proc_tasks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">proc_tasks</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">task</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
                <span class="n">ret_tasks</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">tasks</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Processing </span><span class="si">%s</span><span class="s1"> tasks in serial&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tasks</span><span class="p">))</span>
                <span class="n">ret_tasks</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_setup</span><span class="p">(</span>
                        <span class="n">stations</span><span class="o">=</span><span class="n">orig_stations</span><span class="p">,</span> <span class="n">to_return</span><span class="o">=</span><span class="n">to_return</span><span class="p">))</span>
        <span class="n">_db_locks</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">_file_locks</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">scheduler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">lock_dir</span><span class="p">)</span>
            <span class="n">client</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">task</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">ret_tasks</span> <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">to_return</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup</span><span class="p">(</span><span class="o">*</span><span class="n">t</span><span class="p">)</span>

    <span class="n">docstrings</span><span class="o">.</span><span class="n">keep_params</span><span class="p">(</span><span class="s1">&#39;TaskBase.parameters&#39;</span><span class="p">,</span> <span class="s1">&#39;stations&#39;</span><span class="p">)</span>

    <span class="nd">@docstrings.dedent</span>
    <span class="k">def</span> <span class="nf">_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stations</span><span class="p">,</span> <span class="n">to_return</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">copy_tasks</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
               <span class="n">file_locks</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">db_locks</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">lock_dir</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process the given stations</span>

<span class="sd">        This classmethod uses the :class:`TaskBase` framework to run the</span>
<span class="sd">        task of the gwgen model</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        %(TaskManager.setup.parameters)s</span>
<span class="sd">        copy_tasks: bool</span>
<span class="sd">            If True, we will create a copy of the tasks in this manager before</span>
<span class="sd">            setting up the data. This avoids conflicts during parallel</span>
<span class="sd">            processing</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        %(TaskManager.setup.returns)s&quot;&quot;&quot;</span>
        <span class="c1"># sort the tasks for their requirements</span>
        <span class="k">if</span> <span class="n">file_locks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">init_interprocess_locks</span><span class="p">(</span><span class="n">db_locks</span><span class="o">=</span><span class="n">db_locks</span><span class="p">,</span> <span class="n">file_locks</span><span class="o">=</span><span class="n">file_locks</span><span class="p">,</span>
                                    <span class="n">lock_dir</span><span class="o">=</span><span class="n">lock_dir</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">to_return</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">to_return</span> <span class="o">=</span> <span class="p">[</span><span class="n">ini</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">ini</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span> <span class="k">if</span> <span class="n">ini</span><span class="o">.</span><span class="n">has_run</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">:</span>
            <span class="n">instance</span><span class="o">.</span><span class="n">stations</span> <span class="o">=</span> <span class="n">stations</span>
            <span class="c1"># tasks might filter their stations (e.g. the cloud</span>
            <span class="c1"># parameterization) therefore we check again and skip the instance</span>
            <span class="c1"># if necessary</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">stations</span><span class="p">):</span>
                <span class="n">instance</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s1">&#39;Skipping </span><span class="si">%s</span><span class="s1"> task because it contains no stations!&#39;</span><span class="p">,</span>
                    <span class="n">instance</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">task</span><span class="o">.</span><span class="n">threads</span><span class="p">:</span>
                <span class="n">thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">ini</span><span class="p">:</span> <span class="n">ini</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">to_return</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">copy_tasks</span><span class="p">:</span>
            <span class="c1"># copy the instance in order to avoid complications with</span>
            <span class="c1"># parallel processing</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">task</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ret</span><span class="p">[:]):</span>
                <span class="n">ret</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">ini</span><span class="p">:</span> <span class="n">ini</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">to_return</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">):</span>
                <span class="k">del</span> <span class="n">task</span><span class="o">.</span><span class="n">data</span>
        <span class="k">return</span> <span class="n">ret</span>

<div class="viewcode-block" id="TaskManager.run"><a class="viewcode-back" href="../../api/gwgen.utils.html#gwgen.utils.TaskManager.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">full_info</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">has_run</span><span class="p">:</span>
                <span class="n">full_info</span><span class="p">[</span><span class="n">task</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
                <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">gwgen</a></h1>






<p>
<iframe src="https://ghbtns.com/github-btn.html?user=ARVE-Research&repo=gwgen&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





    

<p>
<a href="https://travis-ci.org/ARVE-Research/gwgen">
    <img
        alt="https://secure.travis-ci.org/ARVE-Research/gwgen.svg?branch=master"
        src="https://secure.travis-ci.org/ARVE-Research/gwgen.svg?branch=master"
    />
</a>
</p>


<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../command_line/gwgen.html">Command Line API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/gwgen.html">Python API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fortran_api/index.html">Fortran API Reference</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2016, Philipp Sommer.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.3.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
    </div>

    

    
  </body>
</html>