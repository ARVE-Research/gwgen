<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>gwgen.main &mdash; gwgen 1.0.1 documentation</title>
    
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="gwgen 1.0.1 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for gwgen.main</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">division</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">os.path</span> <span class="kn">as</span> <span class="nn">osp</span>
<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">datetime</span> <span class="kn">as</span> <span class="nn">dt</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">repeat</span>
<span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">Namespace</span><span class="p">,</span> <span class="n">RawTextHelpFormatter</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">gwgen.utils</span> <span class="kn">as</span> <span class="nn">utils</span>
<span class="kn">from</span> <span class="nn">gwgen.utils</span> <span class="kn">import</span> <span class="n">docstrings</span>
<span class="kn">from</span> <span class="nn">model_organization</span> <span class="kn">import</span> <span class="n">ModelOrganizer</span>
<span class="kn">from</span> <span class="nn">model_organization.config</span> <span class="kn">import</span> <span class="n">ordered_yaml_dump</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>


<div class="viewcode-block" id="GWGENOrganizer"><a class="viewcode-back" href="../../api/gwgen.main.html#gwgen.main.GWGENOrganizer">[docs]</a><span class="k">class</span> <span class="nc">GWGENOrganizer</span><span class="p">(</span><span class="n">ModelOrganizer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class for organizing a model</span>

<span class="sd">    This class is indended to have hold the basic functions for organizing a</span>
<span class="sd">    model. You can subclass the functions ``setup, init`` to fit to your model.</span>
<span class="sd">    When using the model from the command line, you can also use the</span>
<span class="sd">    :meth:`setup_parser` method to create the argument parsers&quot;&quot;&quot;</span>

    <span class="n">commands</span> <span class="o">=</span> <span class="n">ModelOrganizer</span><span class="o">.</span><span class="n">commands</span>
    <span class="n">commands</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">commands</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;init&#39;</span><span class="p">),</span> <span class="s1">&#39;compile_model&#39;</span><span class="p">)</span>
    <span class="n">commands</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">commands</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;archive&#39;</span><span class="p">),</span> <span class="s1">&#39;preproc&#39;</span><span class="p">)</span>
    <span class="n">commands</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">commands</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;archive&#39;</span><span class="p">),</span> <span class="s1">&#39;param&#39;</span><span class="p">)</span>
    <span class="n">commands</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">commands</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;archive&#39;</span><span class="p">),</span> <span class="s1">&#39;run&#39;</span><span class="p">)</span>
    <span class="n">commands</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">commands</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;archive&#39;</span><span class="p">),</span> <span class="s1">&#39;evaluate&#39;</span><span class="p">)</span>
    <span class="n">commands</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">commands</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;archive&#39;</span><span class="p">),</span> <span class="s1">&#39;bias_correction&#39;</span><span class="p">)</span>
    <span class="n">commands</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">commands</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;archive&#39;</span><span class="p">),</span> <span class="s1">&#39;sensitivity_analysis&#39;</span><span class="p">)</span>

    <span class="c1">#: mapping from the name of the parser command to the method name</span>
    <span class="n">parser_commands</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;compile_model&#39;</span><span class="p">:</span> <span class="s1">&#39;compile&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;sensitivity_analysis&#39;</span><span class="p">:</span> <span class="s1">&#39;sens&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;bias_correction&#39;</span><span class="p">:</span> <span class="s1">&#39;bias&#39;</span><span class="p">}</span>

    <span class="c1">#: list of str. The keys describing paths for the model</span>
    <span class="n">paths</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;expdir&#39;</span><span class="p">,</span> <span class="s1">&#39;src&#39;</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;param_stations&#39;</span><span class="p">,</span> <span class="s1">&#39;eval_stations&#39;</span><span class="p">,</span>
             <span class="s1">&#39;indir&#39;</span><span class="p">,</span> <span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="s1">&#39;outdir&#39;</span><span class="p">,</span> <span class="s1">&#39;outdata&#39;</span><span class="p">,</span> <span class="s1">&#39;nc_file&#39;</span><span class="p">,</span>  <span class="s1">&#39;project_file&#39;</span><span class="p">,</span>
             <span class="s1">&#39;plot_file&#39;</span><span class="p">,</span> <span class="s1">&#39;reference&#39;</span><span class="p">,</span> <span class="s1">&#39;evaldir&#39;</span><span class="p">,</span> <span class="s1">&#39;paramdir&#39;</span><span class="p">,</span> <span class="s1">&#39;workdir&#39;</span><span class="p">,</span>
             <span class="s1">&#39;param_grid&#39;</span><span class="p">,</span> <span class="s1">&#39;grid&#39;</span><span class="p">,</span> <span class="s1">&#39;eval_grid&#39;</span><span class="p">]</span>

    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;gwgen&#39;</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># --------------------------- Infrastructure ------------------------------</span>
    <span class="c1"># ---------- General parts for organizing the model infrastructure --------</span>
    <span class="c1"># -------------------------------------------------------------------------</span>

    <span class="n">docstrings</span><span class="o">.</span><span class="n">get_sectionsf</span><span class="p">(</span><span class="s1">&#39;ModelOrganizer.setup&#39;</span><span class="p">)(</span>
        <span class="n">docstrings</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="n">ModelOrganizer</span><span class="o">.</span><span class="n">setup</span><span class="p">))</span>

    <span class="nd">@docstrings.dedent</span>
<div class="viewcode-block" id="GWGENOrganizer.setup"><a class="viewcode-back" href="../../api/gwgen.main.html#gwgen.main.GWGENOrganizer.setup">[docs]</a>    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root_dir</span><span class="p">,</span> <span class="n">projectname</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">link</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">src_project</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
              <span class="n">compiler</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform the initial setup for the model</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        %(ModelOrganizer.setup.parameters)s</span>
<span class="sd">        link: bool</span>
<span class="sd">            If set, the source files are linked to the original ones instead</span>
<span class="sd">            of copied</span>
<span class="sd">        src_project: str</span>
<span class="sd">            Another model name to use the source model files from</span>
<span class="sd">        compiler: str</span>
<span class="sd">            The path to the compiler to use. If None, the global compiler</span>
<span class="sd">            option is used</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">root_dir</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">GWGENOrganizer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span>
            <span class="n">root_dir</span><span class="p">,</span> <span class="n">projectname</span><span class="o">=</span><span class="n">projectname</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">projects</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">projectname</span><span class="p">][</span><span class="s1">&#39;src&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">src_dir</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">root_dir</span><span class="p">,</span> <span class="s1">&#39;src&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">osp</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">src_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">src_dir</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">src_project</span><span class="p">:</span>
            <span class="n">module_src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">projects</span><span class="p">[</span><span class="n">src_project</span><span class="p">][</span><span class="s1">&#39;src&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">module_src</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">osp</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s1">&#39;src&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">module_src</span><span class="p">):</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src_dir</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">osp</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">link</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_link</span><span class="p">(</span><span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">module_src</span><span class="p">,</span> <span class="n">f</span><span class="p">),</span> <span class="n">target</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">module_src</span><span class="p">,</span> <span class="n">f</span><span class="p">),</span> <span class="n">target</span><span class="p">)</span>
        <span class="n">compiler</span> <span class="o">=</span> <span class="n">compiler</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;compiler&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">compiler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src_dir</span><span class="p">,</span> <span class="s1">&#39;Makefile&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">make_file</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">make_file</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;^\s*FC\s*=\s*.*$&#39;</span><span class="p">,</span> <span class="s1">&#39;FC = &#39;</span> <span class="o">+</span> <span class="n">compiler</span><span class="p">,</span>
                               <span class="n">make_file</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src_dir</span><span class="p">,</span> <span class="s1">&#39;Makefile&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">make_file</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">root_dir</span></div>

    <span class="k">def</span> <span class="nf">_modify_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">):</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">setup_args</span><span class="p">(</span><span class="n">ModelOrganizer</span><span class="o">.</span><span class="n">setup</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_modify_app_main</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">update_arg</span><span class="p">(</span><span class="s1">&#39;src_project&#39;</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="s1">&#39;src&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">update_arg</span><span class="p">(</span><span class="s1">&#39;compiler&#39;</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>

    <span class="nd">@docstrings.dedent</span>
<div class="viewcode-block" id="GWGENOrganizer.compile_model"><a class="viewcode-back" href="../../api/gwgen.main.html#gwgen.main.GWGENOrganizer.compile_model">[docs]</a>    <span class="k">def</span> <span class="nf">compile_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">projectname</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compile the model</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        projectname: str</span>
<span class="sd">            The name of the project. If None, use the last one or the one</span>
<span class="sd">            specified by the current experiment</span>
<span class="sd">        ``**kwargs``</span>
<span class="sd">            Keyword arguments passed to the :meth:`app_main` method</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">subprocess</span> <span class="kn">as</span> <span class="nn">spr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app_main</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">projectname</span> <span class="o">=</span> <span class="n">projectname</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">projectname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">projectname</span> <span class="o">=</span> <span class="n">projectname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Compiling </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">projectname</span><span class="p">)</span>
        <span class="n">pdict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">projects</span><span class="p">[</span><span class="n">projectname</span><span class="p">]</span>
        <span class="n">pdict</span><span class="p">[</span><span class="s1">&#39;bindir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bin_dir</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pdict</span><span class="p">[</span><span class="s1">&#39;root&#39;</span><span class="p">],</span> <span class="s1">&#39;bin&#39;</span><span class="p">)</span>
        <span class="n">pdict</span><span class="p">[</span><span class="s1">&#39;bin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bin_dir</span><span class="p">,</span> <span class="s1">&#39;weathergen&#39;</span><span class="p">)</span>
        <span class="n">src_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">pdict</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">bin_dir</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;    Creating bin directory </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">bin_dir</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">bin_dir</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">src_dir</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;    Linking </span><span class="si">%s</span><span class="s2">...&quot;</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bin_dir</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">osp</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_link</span><span class="p">(</span><span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src_dir</span><span class="p">,</span> <span class="n">f</span><span class="p">),</span> <span class="n">target</span><span class="p">)</span>
        <span class="n">spr</span><span class="o">.</span><span class="n">check_call</span><span class="p">([</span><span class="s1">&#39;make&#39;</span><span class="p">,</span> <span class="s1">&#39;-C&#39;</span><span class="p">,</span> <span class="n">bin_dir</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">],</span> <span class="n">stdout</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span>
                       <span class="n">stderr</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Compilation done.&#39;</span><span class="p">)</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_config</span><span class="p">[</span><span class="s1">&#39;timestamps&#39;</span><span class="p">]</span>
        <span class="n">ts</span><span class="p">[</span><span class="s1">&#39;compile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ts</span><span class="p">[</span><span class="s1">&#39;compile_model &#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_modify_compile_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Does nothing since compile takes no special arguments&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_modify_app_main</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># -------------------------- Configuration --------------------------------</span>
    <span class="c1"># ------------------ Parts for configuring the organizer ------------------</span>
    <span class="c1"># -------------------------------------------------------------------------</span>

    <span class="n">docstrings</span><span class="o">.</span><span class="n">get_sectionsf</span><span class="p">(</span><span class="s2">&quot;ModelOrganizer.configure&quot;</span><span class="p">)(</span><span class="n">docstrings</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span>
        <span class="n">ModelOrganizer</span><span class="o">.</span><span class="n">configure</span><span class="p">))</span>

    <span class="nd">@docstrings.dedent</span>
<div class="viewcode-block" id="GWGENOrganizer.configure"><a class="viewcode-back" href="../../api/gwgen.main.html#gwgen.main.GWGENOrganizer.configure">[docs]</a>    <span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update_nml</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">max_stations</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                  <span class="n">datadir</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">database</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                  <span class="n">chunksize</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">compiler</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Configure the projects and experiments</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        %(ModelOrganizer.configure.parameters)s</span>
<span class="sd">        update_nml: str or dict</span>
<span class="sd">            A python dict or path to a namelist to use for updating the</span>
<span class="sd">            namelist of the experiment</span>
<span class="sd">        max_stations: int</span>
<span class="sd">            The maximum number of stations to process in one parameterization</span>
<span class="sd">            process. Does automatically impact global settings</span>
<span class="sd">        datadir: str</span>
<span class="sd">            Path to the data directory to use (impacts the project</span>
<span class="sd">            configuration)</span>
<span class="sd">        database: str</span>
<span class="sd">            The name of a postgres data base to write the data to</span>
<span class="sd">        user: str</span>
<span class="sd">            The username to use when logging into the database</span>
<span class="sd">        host: str</span>
<span class="sd">            the host which runs the database server</span>
<span class="sd">        port: int</span>
<span class="sd">            The port to use to log into the the database</span>
<span class="sd">        chunksize: int</span>
<span class="sd">            The chunksize to use for the parameterization and evaluation</span>
<span class="sd">        compiler: str</span>
<span class="sd">            The path to the fortran compiler to use&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GWGENOrganizer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">exp_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span>
        <span class="k">if</span> <span class="n">update_nml</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">f90nml</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">update_nml</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">ref_nml</span> <span class="o">=</span> <span class="n">f90nml</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="n">nml2use</span> <span class="o">=</span> <span class="n">exp_config</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;namelist&#39;</span><span class="p">,</span> <span class="n">OrderedDict</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">nml</span> <span class="ow">in</span> <span class="n">ref_nml</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">nml2use</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">OrderedDict</span><span class="p">())</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">nml</span><span class="p">))</span>
        <span class="n">gconf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">global_config</span>
        <span class="k">if</span> <span class="n">max_stations</span><span class="p">:</span>
            <span class="n">gconf</span><span class="p">[</span><span class="s1">&#39;max_stations&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_stations</span>
        <span class="k">if</span> <span class="n">datadir</span><span class="p">:</span>
            <span class="n">datadir</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">datadir</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">project_config</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datadir</span>
        <span class="k">if</span> <span class="n">database</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">exp_config</span><span class="p">[</span><span class="s1">&#39;database&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">database</span>
        <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">gconf</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span>
        <span class="k">if</span> <span class="n">port</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">gconf</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">port</span>
        <span class="k">if</span> <span class="n">host</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">gconf</span><span class="p">[</span><span class="s1">&#39;host&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;127.0.0.1&#39;</span>
        <span class="k">if</span> <span class="n">chunksize</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">gconf</span><span class="p">[</span><span class="s1">&#39;chunksize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chunksize</span>
        <span class="k">if</span> <span class="n">compiler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">gconf</span><span class="p">[</span><span class="s1">&#39;compiler&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">compiler</span></div>

    <span class="k">def</span> <span class="nf">_modify_configure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">):</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">setup_args</span><span class="p">(</span><span class="nb">super</span><span class="p">(</span><span class="n">GWGENOrganizer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">configure</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GWGENOrganizer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_modify_configure</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">update_arg</span><span class="p">(</span><span class="s1">&#39;datadir&#39;</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">update_arg</span><span class="p">(</span><span class="s1">&#39;update_nml&#39;</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="s1">&#39;u&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">update_arg</span><span class="p">(</span><span class="s1">&#39;max_stations&#39;</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">update_arg</span><span class="p">(</span><span class="s1">&#39;database&#39;</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="s1">&#39;db&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">update_arg</span><span class="p">(</span><span class="s1">&#39;compiler&#39;</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># -------------------------- Preprocessing --------------------------------</span>
    <span class="c1"># -------------- Preprocessing functions for the experiment ---------------</span>
    <span class="c1"># -------------------------------------------------------------------------</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">preproc_funcs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A mapping from preproc commands to the corresponding function&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;select&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">select</span><span class="p">,</span>
                <span class="s1">&#39;cloud&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cloud_preproc</span><span class="p">,</span>
                <span class="s1">&#39;test&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_test_sample</span><span class="p">}</span>

    <span class="nd">@docstrings.dedent</span>
<div class="viewcode-block" id="GWGENOrganizer.preproc"><a class="viewcode-back" href="../../api/gwgen.main.html#gwgen.main.GWGENOrganizer.preproc">[docs]</a>    <span class="k">def</span> <span class="nf">preproc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Preprocess the data</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ``**kwargs``</span>
<span class="sd">            Any keyword from the :attr:`preproc` attribute with kws for the</span>
<span class="sd">            corresponding function, or any keyword for the :meth:`main` method</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">funcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preproc_funcs</span>
        <span class="n">sp_kws</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span>
            <span class="n">funcs</span><span class="p">)}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app_main</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">exp_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_paths</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="p">)</span>
        <span class="n">outdir</span> <span class="o">=</span> <span class="n">exp_config</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;indir&#39;</span><span class="p">,</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">exp_config</span><span class="p">[</span><span class="s1">&#39;expdir&#39;</span><span class="p">],</span> <span class="s1">&#39;input&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">osp</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outdir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">outdir</span><span class="p">)</span>

        <span class="n">preproc_config</span> <span class="o">=</span> <span class="n">exp_config</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;preproc&#39;</span><span class="p">,</span> <span class="n">OrderedDict</span><span class="p">())</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">sp_kws</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">Namespace</span><span class="p">):</span>
                <span class="n">val</span> <span class="o">=</span> <span class="nb">vars</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">funcs</span><span class="p">[</span><span class="n">key</span><span class="p">](</span><span class="o">**</span><span class="n">val</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">info</span><span class="p">:</span>
                <span class="n">preproc_config</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span></div>

    <span class="k">def</span> <span class="nf">_modify_preproc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">gwgen.preproc</span> <span class="kn">import</span> <span class="n">CloudPreproc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_modify_app_main</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>
        <span class="n">sps</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_subparsers</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Preprocessing tasks&#39;</span><span class="p">,</span> <span class="n">chain</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="c1"># select</span>
        <span class="n">sp</span> <span class="o">=</span> <span class="n">sps</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span>
            <span class="s1">&#39;select&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Select stations based upon a regular grid&#39;</span><span class="p">)</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">setup_args</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">select</span><span class="p">)</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">update_arg</span><span class="p">(</span><span class="s1">&#39;grid&#39;</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">)</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">update_arg</span><span class="p">(</span><span class="s1">&#39;grid_output&#39;</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="s1">&#39;og&#39;</span><span class="p">)</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">update_arg</span><span class="p">(</span><span class="s1">&#39;stations_output&#39;</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="s1">&#39;os&#39;</span><span class="p">)</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">update_arg</span><span class="p">(</span><span class="s1">&#39;igrid_key&#39;</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">update_arg</span><span class="p">(</span><span class="s1">&#39;grid_key&#39;</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="s1">&#39;ok&#39;</span><span class="p">)</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">update_arg</span><span class="p">(</span><span class="s1">&#39;grid_db&#39;</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="s1">&#39;gdb&#39;</span><span class="p">)</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">update_arg</span><span class="p">(</span><span class="s1">&#39;stations_db&#39;</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="s1">&#39;sdb&#39;</span><span class="p">)</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">update_arg</span><span class="p">(</span><span class="s1">&#39;no_prcp_check&#39;</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="s1">&#39;nc&#39;</span><span class="p">)</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">update_arg</span><span class="p">(</span><span class="s1">&#39;setup_from&#39;</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="nb">long</span><span class="o">=</span><span class="s1">&#39;from&#39;</span><span class="p">,</span>
                      <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;setup_from&#39;</span><span class="p">)</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">update_arg</span><span class="p">(</span><span class="s1">&#39;download&#39;</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;single&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">])</span>

        <span class="c1"># cloud preprocessing</span>
        <span class="n">sp</span> <span class="o">=</span> <span class="n">sps</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s1">&#39;cloud&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Cloud preprocessing&#39;</span><span class="p">)</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">setup_args</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cloud_preproc</span><span class="p">)</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">update_arg</span><span class="p">(</span><span class="s1">&#39;max_files&#39;</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="s1">&#39;mf&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">pop_arg</span><span class="p">(</span><span class="s1">&#39;return_manager&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_modify_task_parser</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">CloudPreproc</span><span class="p">)</span>

        <span class="c1"># test samples</span>
        <span class="n">sp</span> <span class="o">=</span> <span class="n">sps</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span>
            <span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Create a test sample for selected GHCN stations&#39;</span><span class="p">)</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">setup_args</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">create_test_sample</span><span class="p">)</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">update_arg</span><span class="p">(</span><span class="s1">&#39;no_cloud&#39;</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="s1">&#39;nc&#39;</span><span class="p">)</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">update_arg</span><span class="p">(</span><span class="s1">&#39;reduce_eecra&#39;</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="s1">&#39;re&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">update_arg</span><span class="p">(</span><span class="s1">&#39;keep_all&#39;</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">parser</span>

    <span class="c1"># ------------------------------- Selection -------------------------------</span>

    <span class="k">def</span> <span class="nf">_prcp_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">series</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">11</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">series</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;prcp&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_prcp_test</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">prcp</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">_select_best_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">test_series</span><span class="p">,</span> <span class="n">kws</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">gwgen.parameterization</span> <span class="kn">import</span> <span class="n">DailyGHCNData</span>
        <span class="c1"># disable logging for the DailyGHCNData task</span>
        <span class="n">task_logger</span> <span class="o">=</span> <span class="n">DailyGHCNData</span><span class="p">([],</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_config</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">global_config</span><span class="p">)</span><span class="o">.</span><span class="n">logger</span>
        <span class="n">orig_level</span> <span class="o">=</span> <span class="n">task_logger</span><span class="o">.</span><span class="n">level</span>
        <span class="n">task_logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_series</span> <span class="o">=</span> <span class="n">test_series</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_select_kws</span> <span class="o">=</span> <span class="n">kws</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_select_task</span> <span class="o">=</span> <span class="n">DailyGHCNData</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;nyrs&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
            <span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;clon&#39;</span><span class="p">,</span> <span class="s1">&#39;clat&#39;</span><span class="p">])</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_select_best</span><span class="p">)</span>
        <span class="n">task_logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">orig_level</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">def</span> <span class="nf">_select_best</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">series</span><span class="p">):</span>
        <span class="n">test_series</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_series</span>
        <span class="k">for</span> <span class="n">station</span> <span class="ow">in</span> <span class="n">series</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
            <span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_task</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">station</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_config</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">global_config</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_select_kws</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">task</span><span class="o">.</span><span class="n">init_task</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">FileNotFoundError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">task</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">task</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_series</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span>
                    <span class="n">task</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;prcp&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="n">test_series</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">prcp</span><span class="o">.</span><span class="n">unique</span><span class="p">()):</span>
                    <span class="k">return</span> <span class="n">station</span>
        <span class="k">return</span> <span class="n">series</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_parallel_select</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
        <span class="n">organizer</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">test_series</span><span class="p">,</span> <span class="n">kws</span> <span class="o">=</span> <span class="n">l</span>
        <span class="k">return</span> <span class="n">organizer</span><span class="o">.</span><span class="n">_select_best_df</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">test_series</span><span class="p">,</span> <span class="n">kws</span><span class="p">)</span>

    <span class="nd">@docstrings.dedent</span>
<div class="viewcode-block" id="GWGENOrganizer.select"><a class="viewcode-back" href="../../api/gwgen.main.html#gwgen.main.GWGENOrganizer.select">[docs]</a>    <span class="k">def</span> <span class="nf">select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">grid_output</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">stations_output</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
               <span class="n">igrid_key</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">grid_key</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">grid_db</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">stations_db</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
               <span class="n">no_prcp_check</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">setup_from</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">download</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Select stations based upon a regular grid</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        grid: str</span>
<span class="sd">            The path to a csv-file containing a lat and a lon column with the</span>
<span class="sd">            information on the centers of the grid. If None, `igrid_key` must</span>
<span class="sd">            not be None and point to a key in the configuration (either the one</span>
<span class="sd">            of the experiment, or the project, or the global configuration)</span>
<span class="sd">            specifying the path</span>
<span class="sd">        grid_output: str</span>
<span class="sd">            The path to the csv-file where to store the mapping from grid</span>
<span class="sd">            lat-lon to station id.</span>
<span class="sd">        stations_output: str</span>
<span class="sd">            The path to the csv-file where to store the mapping from station</span>
<span class="sd">            to grid center point</span>
<span class="sd">        igrid_key: str</span>
<span class="sd">            The key in the configuration where to store the path of the `grid`</span>
<span class="sd">            input file</span>
<span class="sd">        grid_key: str</span>
<span class="sd">            The key in the configuration where to store the name of the</span>
<span class="sd">            `grid_output` file.</span>
<span class="sd">        grid_db: str</span>
<span class="sd">            The name of a data table to store the data of `stations_output` in</span>
<span class="sd">        stations_db: str</span>
<span class="sd">            The name of a data table to store the data for `stations_output` in</span>
<span class="sd">        no_prcp_check: bool</span>
<span class="sd">            If True, we will not check for the values between 0.1 and 1.0 for</span>
<span class="sd">            precipitation and save the result in the ``&#39;best&#39;`` column</span>
<span class="sd">        setup_from: { &#39;scratch&#39; | &#39;file&#39; | &#39;db&#39; }</span>
<span class="sd">            The setup method for the daily data for the prcp check</span>
<span class="sd">        download: { &#39;single&#39; | &#39;all&#39; }</span>
<span class="sd">            Handles how to manage missing files for the prcp check. If None</span>
<span class="sd">            (default), an warning is printed and the file is ignored, if</span>
<span class="sd">            ``&#39;single&#39;``, the missing file is downloaded, if ``&#39;all&#39;``, the</span>
<span class="sd">            entire tarball is downloaded (strongly not recommended for this</span>
<span class="sd">            function)</span>

<span class="sd">        Other Parameters</span>
<span class="sd">        ----------------</span>
<span class="sd">        ``**kwargs``</span>
<span class="sd">            are passed to the :meth:`main` method</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        for `igrid_key` and `ogrid_key` we recommend one of</span>
<span class="sd">        ``{&#39;grid&#39;, &#39;param_grid&#39;, &#39;eval_grid&#39;`` because that implies a</span>
<span class="sd">        correct path management</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">gwgen.evaluation</span> <span class="kn">import</span> <span class="n">EvaluationPreparation</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
        <span class="kn">import</span> <span class="nn">scipy.spatial</span>
        <span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>

        <span class="n">logger</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span>

        <span class="k">if</span> <span class="n">grid</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">igrid_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">igrid_key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="n">igrid_key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">igrid_key</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;No grid file or configuration key specified!&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">grid</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;No grid file specified and &#39;</span><span class="si">%s</span><span class="s2">&#39; could not be found in &quot;</span>
                    <span class="s2">&quot;the configuration!&quot;</span> <span class="o">%</span> <span class="n">igrid_key</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">EvaluationPreparation</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">project_config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_config</span><span class="p">)</span>
        <span class="c1"># get inventory</span>
        <span class="n">t</span><span class="o">.</span><span class="n">download_src</span><span class="p">()</span>
        <span class="n">df_stations</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">station_list</span>
        <span class="n">df_stations</span> <span class="o">=</span> <span class="n">df_stations</span><span class="p">[</span><span class="n">df_stations</span><span class="o">.</span><span class="n">vname</span> <span class="o">==</span> <span class="s1">&#39;PRCP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
            <span class="s1">&#39;vname&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>  <span class="c1"># reset_index required due to filtering</span>
        <span class="n">df_stations</span><span class="p">[</span><span class="s1">&#39;nyrs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_stations</span><span class="o">.</span><span class="n">lastyr</span> <span class="o">-</span> <span class="n">df_stations</span><span class="o">.</span><span class="n">firstyr</span>

        <span class="c1"># read 1D grid information</span>
        <span class="n">df_centers</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>
        <span class="n">df_centers</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;lon&#39;</span><span class="p">:</span> <span class="s1">&#39;clon&#39;</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">:</span> <span class="s1">&#39;clat&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="c1"># concatenate lat and lon values into x-y points</span>
        <span class="n">center_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">(</span>
            <span class="p">[</span><span class="n">df_centers</span><span class="o">.</span><span class="n">clat</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">df_centers</span><span class="o">.</span><span class="n">clon</span><span class="o">.</span><span class="n">values</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">station_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">([</span><span class="n">df_stations</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">df_stations</span><span class="o">.</span><span class="n">lon</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># look up the nearest neighbor</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Searching neighbors...&#39;</span><span class="p">)</span>
        <span class="n">kdtree</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">spatial</span><span class="o">.</span><span class="n">cKDTree</span><span class="p">(</span><span class="n">center_points</span><span class="p">)</span>
        <span class="n">dist</span><span class="p">,</span> <span class="n">indexes</span> <span class="o">=</span> <span class="n">kdtree</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">station_points</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Done.&#39;</span><span class="p">)</span>

        <span class="c1"># store the lat and longitude of, and the distance to the center grid</span>
        <span class="c1"># point in the stations table</span>
        <span class="n">df_stations</span><span class="p">[</span><span class="s1">&#39;clon&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_centers</span><span class="o">.</span><span class="n">clon</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">indexes</span><span class="p">]</span>
        <span class="n">df_stations</span><span class="p">[</span><span class="s1">&#39;clat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_centers</span><span class="o">.</span><span class="n">clat</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">indexes</span><span class="p">]</span>
        <span class="n">df_stations</span><span class="p">[</span><span class="s1">&#39;dist&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dist</span>

        <span class="c1"># --------- stations with the closest distance to grid center ---------</span>
        <span class="c1"># group by the center coordinates and look for the index with the</span>
        <span class="c1"># smallest distance</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">df_stations</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;clon&#39;</span><span class="p">,</span> <span class="s1">&#39;clat&#39;</span><span class="p">])</span>
        <span class="n">indices_closest</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">dist</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()</span>
        <span class="n">indices_longest</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">nyrs</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span>
        <span class="c1"># merge the nearest stations into the centers table</span>
        <span class="n">df_centers</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;clon&#39;</span><span class="p">,</span> <span class="s1">&#39;clat&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">df_stations</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;clon&#39;</span><span class="p">,</span> <span class="s1">&#39;clat&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">merged</span> <span class="o">=</span> <span class="n">df_centers</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">df_stations</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">indices_closest</span><span class="p">][[</span><span class="s1">&#39;id&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="s1">&#39;nearest_station&#39;</span><span class="p">}),</span>
            <span class="n">left_index</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">)</span>
        <span class="n">merged</span> <span class="o">=</span> <span class="n">merged</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">df_stations</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">indices_longest</span><span class="p">][[</span><span class="s1">&#39;id&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="s1">&#39;longest_record&#39;</span><span class="p">}),</span>
            <span class="n">left_index</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">no_prcp_check</span><span class="p">:</span>
            <span class="n">test_series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;prcp&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Performing best station check with </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                         <span class="n">test_series</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="n">kws</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">download</span><span class="o">=</span><span class="n">download</span><span class="p">,</span> <span class="n">setup_from</span><span class="o">=</span><span class="n">setup_from</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;serial&#39;</span><span class="p">):</span>
                <span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="kn">as</span> <span class="nn">mp</span>
                <span class="n">nprocs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nprocs&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">)</span>
                <span class="n">lonlats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">df_stations</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">nprocs</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                    <span class="n">nprocs</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>
                <span class="n">splitted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array_split</span><span class="p">(</span><span class="n">lonlats</span><span class="p">,</span> <span class="n">nprocs</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">nprocs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">splitted</span><span class="p">))</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">splitted</span> <span class="o">=</span> <span class="n">splitted</span><span class="p">[:</span><span class="n">nprocs</span><span class="p">]</span>
                <span class="n">dfs</span> <span class="o">=</span> <span class="p">[</span><span class="n">df_stations</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">arr</span><span class="p">)]</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">splitted</span><span class="p">]</span>
                <span class="c1"># initializing pool</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Start </span><span class="si">%i</span><span class="s1"> processes&#39;</span><span class="p">,</span> <span class="n">nprocs</span><span class="p">)</span>
                <span class="n">pool</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">nprocs</span><span class="p">)</span>
                <span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">repeat</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">dfs</span><span class="p">,</span> <span class="n">repeat</span><span class="p">(</span><span class="n">test_series</span><span class="p">),</span>
                                <span class="n">repeat</span><span class="p">(</span><span class="n">kws</span><span class="p">)))</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map_async</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parallel_select</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
                <span class="n">best</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
                <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
                <span class="n">pool</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">best</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_best_df</span><span class="p">(</span>
                    <span class="n">df_stations</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">test_series</span><span class="p">,</span> <span class="n">kws</span><span class="p">)</span>
            <span class="n">merged</span> <span class="o">=</span> <span class="n">merged</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                <span class="n">best</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="s1">&#39;best&#39;</span><span class="p">}),</span>
                <span class="n">left_index</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">igrid_key</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="p">[</span><span class="n">igrid_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">grid</span>
        <span class="k">if</span> <span class="n">stations_output</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Dumping to</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                         <span class="s1">&#39; exisiting&#39;</span> <span class="k">if</span> <span class="n">osp</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">stations_output</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                         <span class="n">stations_output</span><span class="p">)</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">safe_csv_append</span><span class="p">(</span><span class="n">df_stations</span><span class="p">,</span> <span class="n">stations_output</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">grid_output</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Dumping to</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                         <span class="s1">&#39; exisiting&#39;</span> <span class="k">if</span> <span class="n">osp</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">grid_output</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                         <span class="n">grid_output</span><span class="p">)</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">safe_csv_append</span><span class="p">(</span><span class="n">merged</span><span class="p">,</span> <span class="n">grid_output</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">grid_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="p">[</span><span class="n">grid_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">grid_output</span>
        <span class="k">if</span> <span class="n">stations_db</span> <span class="ow">or</span> <span class="n">grid_db</span><span class="p">:</span>
            <span class="n">conn</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">stations_db</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Writing </span><span class="si">%i</span><span class="s1"> lines into </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_stations</span><span class="p">),</span>
                            <span class="n">stations_db</span><span class="p">)</span>
                <span class="n">df_stations</span><span class="o">.</span><span class="n">to_sql</span><span class="p">(</span><span class="n">stations_db</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="s1">&#39;append&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">grid_db</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Writing </span><span class="si">%i</span><span class="s1"> lines into </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">merged</span><span class="p">),</span>
                            <span class="n">grid_db</span><span class="p">)</span>
                <span class="n">merged</span><span class="o">.</span><span class="n">to_sql</span><span class="p">(</span><span class="n">grid_db</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="s1">&#39;append&#39;</span><span class="p">)</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">df_stations</span><span class="p">,</span> <span class="n">merged</span></div>

    <span class="c1"># --------------------------- Cloud inventory -----------------------------</span>

    <span class="nd">@docstrings.dedent</span>
<div class="viewcode-block" id="GWGENOrganizer.cloud_preproc"><a class="viewcode-back" href="../../api/gwgen.main.html#gwgen.main.GWGENOrganizer.cloud_preproc">[docs]</a>    <span class="k">def</span> <span class="nf">cloud_preproc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_files</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">return_manager</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract the inventory of EECRA stations</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        max_files: int</span>
<span class="sd">            The maximum number of files to process during one process. If None,</span>
<span class="sd">            it is determined by the global ``&#39;max_stations&#39;`` key</span>
<span class="sd">        ``**kwargs``</span>
<span class="sd">            Any task in the :class:`gwgen.preproc.CloudPreproc` framework</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">gwgen.preproc</span> <span class="kn">import</span> <span class="n">CloudPreproc</span>
        <span class="kn">from</span> <span class="nn">gwgen.parameterization</span> <span class="kn">import</span> <span class="n">HourlyCloud</span>
        <span class="n">stations_orig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_stations&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">max_files</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">global_config</span><span class="p">[</span><span class="s1">&#39;max_stations&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_files</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">HourlyCloud</span><span class="o">.</span><span class="n">from_organizer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">raw_src_files</span>
        <span class="n">manager</span> <span class="o">=</span> <span class="n">CloudPreproc</span><span class="o">.</span><span class="n">get_manager</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">global_config</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">Namespace</span><span class="p">):</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span> <span class="o">=</span> <span class="nb">vars</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                <span class="n">val</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;max_files&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_manager</span><span class="p">(</span><span class="n">manager</span><span class="p">,</span> <span class="n">stations</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">files</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
                            <span class="n">base_kws</span><span class="o">=</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">manager</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">stations_orig</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">global_config</span><span class="p">[</span><span class="s1">&#39;max_stations&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stations_orig</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">global_config</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;max_stations&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">return_manager</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">d</span><span class="p">,</span> <span class="n">manager</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">d</span></div>

    <span class="c1"># --------------------------- Parameterization ----------------------------</span>

    <span class="nd">@docstrings.get_sectionsf</span><span class="p">(</span><span class="s1">&#39;GWGENOrganizer.param&#39;</span><span class="p">)</span>
    <span class="nd">@docstrings.dedent</span>
<div class="viewcode-block" id="GWGENOrganizer.param"><a class="viewcode-back" href="../../api/gwgen.main.html#gwgen.main.GWGENOrganizer.param">[docs]</a>    <span class="k">def</span> <span class="nf">param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">complete</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">stations</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">other_exp</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
              <span class="n">setup_from</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">to_db</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">to_csv</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">database</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
              <span class="n">norun</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">to_return</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameterize the experiment</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        stations: str or list of str</span>
<span class="sd">            either a list of stations to use or a filename containing a</span>
<span class="sd">            1-row table with stations</span>
<span class="sd">        other_exp: str</span>
<span class="sd">            Use the configuration from another experiment</span>
<span class="sd">        setup_from: str</span>
<span class="sd">            Determine where to get the data from. If `scratch`, the</span>
<span class="sd">            data will be calculated from the raw data. If `file`,</span>
<span class="sd">            the data will be loaded from a file, if `db`, the data</span>
<span class="sd">            will be loaded from a postgres database (Note that the</span>
<span class="sd">            `database` argument must be provided!).</span>
<span class="sd">        to_db: bool</span>
<span class="sd">            Save the data into a postgresql database (Note that the</span>
<span class="sd">            `database` argument must be provided!)</span>
<span class="sd">        to_csv: bool</span>
<span class="sd">            Save the data into a csv file</span>
<span class="sd">        database: str</span>
<span class="sd">            The name of a postgres data base to write the data to</span>
<span class="sd">        norun: bool, list of str or ``&#39;all&#39;``</span>
<span class="sd">            If True, only the data is set up and the configuration of the</span>
<span class="sd">            experiment is not affected. It can be either a list of  tasks or</span>
<span class="sd">            True or ``&#39;all&#39;``</span>
<span class="sd">        to_return: list of str or ``&#39;all&#39;``</span>
<span class="sd">            The names of the tasks to return. If None, only the ones with an</span>
<span class="sd">            :attr:`gwgen.utils.TaskBase.has_run` are returned.</span>
<span class="sd">        complete: bool</span>
<span class="sd">            If True, setup and run all possible tasks</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">gwgen.parameterization</span> <span class="kn">import</span> <span class="n">Parameterizer</span>
        <span class="n">task_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">task</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">Parameterizer</span><span class="o">.</span><span class="n">_registry</span><span class="p">]</span>
        <span class="n">parameterizer_kws</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">key</span><span class="p">:</span> <span class="nb">vars</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">Namespace</span><span class="p">)</span> <span class="k">else</span> <span class="nb">dict</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">task_names</span><span class="p">}</span>
        <span class="n">main_kws</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">val</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">task_names</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app_main</span><span class="p">(</span><span class="o">**</span><span class="n">main_kws</span><span class="p">)</span>
        <span class="n">experiment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span>
        <span class="n">exp_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_paths</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">experiments</span><span class="p">[</span><span class="n">experiment</span><span class="p">])</span>
        <span class="n">param_dir</span> <span class="o">=</span> <span class="n">exp_dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span>
            <span class="s1">&#39;paramdir&#39;</span><span class="p">,</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">exp_dict</span><span class="p">[</span><span class="s1">&#39;expdir&#39;</span><span class="p">],</span> <span class="s1">&#39;parameterization&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">osp</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">param_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">param_dir</span><span class="p">)</span>
        <span class="n">projectname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">projectname</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Parameterizing experiment </span><span class="si">%s</span><span class="s2"> of project </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">experiment</span><span class="p">,</span> <span class="n">projectname</span><span class="p">)</span>
        <span class="n">stations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_stations</span><span class="p">(</span><span class="n">stations</span><span class="p">,</span> <span class="n">other_exp</span><span class="p">,</span> <span class="n">param_dir</span><span class="p">,</span>
                                      <span class="s1">&#39;param_stations&#39;</span><span class="p">)</span>
        <span class="n">global_conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">global_config</span>
        <span class="c1"># choose keywords for data processing</span>
        <span class="n">manager</span> <span class="o">=</span> <span class="n">Parameterizer</span><span class="o">.</span><span class="n">get_manager</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">global_conf</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_manager</span><span class="p">(</span><span class="n">manager</span><span class="p">,</span> <span class="n">stations</span><span class="p">,</span> <span class="n">other_exp</span><span class="p">,</span> <span class="n">setup_from</span><span class="p">,</span> <span class="n">to_db</span><span class="p">,</span>
                            <span class="n">to_csv</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="n">to_return</span><span class="p">,</span> <span class="n">complete</span><span class="p">,</span>
                            <span class="n">parameterizer_kws</span><span class="p">)</span>
        <span class="c1"># update experiment namelist and configuration</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">norun</span><span class="p">:</span>
            <span class="n">manager</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">exp_dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;parameterization&#39;</span><span class="p">,</span> <span class="n">OrderedDict</span><span class="p">()),</span>
                        <span class="n">exp_dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;namelist&#39;</span><span class="p">,</span> <span class="n">OrderedDict</span><span class="p">()))</span>
        <span class="k">return</span> <span class="n">manager</span></div>

    <span class="k">def</span> <span class="nf">_modify_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">gwgen.parameterization</span> <span class="kn">import</span> <span class="n">Parameterizer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_modify_task_parser</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">Parameterizer</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># --------------------------------- Test ----------------------------------</span>

    <span class="nd">@docstrings.dedent</span>
<div class="viewcode-block" id="GWGENOrganizer.create_test_sample"><a class="viewcode-back" href="../../api/gwgen.main.html#gwgen.main.GWGENOrganizer.create_test_sample">[docs]</a>    <span class="k">def</span> <span class="nf">create_test_sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_dir</span><span class="p">,</span> <span class="n">stations</span><span class="p">,</span> <span class="n">no_cloud</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                           <span class="n">reduce_eecra</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keep_all</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a test sample for the given GHCN stations</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        test_dir: str</span>
<span class="sd">            The path to the directory containing the test files from Github</span>
<span class="sd">        stations: str or list of str</span>
<span class="sd">            either a list of GHCN stations to use or a filename containing a</span>
<span class="sd">            1-row table with GHCN stations</span>
<span class="sd">        no_cloud: bool</span>
<span class="sd">            If True, no cloud stations are extracted</span>
<span class="sd">        reduce_eecra: float</span>
<span class="sd">            The percentage by which to reduce the EECRA data</span>
<span class="sd">        keep_all: bool</span>
<span class="sd">            If True all years of the EECRA data are used. Otherwise, only the</span>
<span class="sd">            years with complete temperature and cloud are kept. Note</span>
<span class="sd">            that this has only an effect if `reduce_eecra` is not 0</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">calendar</span>
        <span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
        <span class="kn">from</span> <span class="nn">gwgen.parameterization</span> <span class="kn">import</span> <span class="n">DailyGHCNData</span><span class="p">,</span> <span class="n">HourlyCloud</span>

        <span class="k">def</span> <span class="nf">is_complete</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="n">ndays</span> <span class="o">=</span> <span class="mi">366</span> <span class="k">if</span> <span class="n">calendar</span><span class="o">.</span><span class="n">isleap</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">else</span> <span class="mi">365</span>
            <span class="n">s</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="o">~</span><span class="n">s</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">duplicated</span><span class="p">()]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="n">ndays</span>
            <span class="k">return</span> <span class="n">s</span>

        <span class="n">stations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_stations</span><span class="p">(</span><span class="n">stations</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">test_dir</span><span class="p">,</span> <span class="s1">&#39;test_stations.dat&#39;</span><span class="p">),</span> <span class="n">stations</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># download the GHCN data</span>
        <span class="n">ghcn_task</span> <span class="o">=</span> <span class="n">DailyGHCNData</span><span class="o">.</span><span class="n">from_organizer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stations</span><span class="p">,</span>
                                                 <span class="n">download</span><span class="o">=</span><span class="s1">&#39;single&#39;</span><span class="p">)</span>
        <span class="n">ghcn_task</span><span class="o">.</span><span class="n">init_from_scratch</span><span class="p">()</span>
        <span class="n">data_dir</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">DailyGHCNData</span><span class="p">,</span> <span class="n">ghcn_task</span><span class="p">)</span><span class="o">.</span><span class="n">data_dir</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">no_cloud</span><span class="p">:</span>
            <span class="n">eecra_task</span> <span class="o">=</span> <span class="n">HourlyCloud</span><span class="o">.</span><span class="n">from_organizer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stations</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">eecra_task</span><span class="o">.</span><span class="n">stations</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Could not find any station in the given stations </span><span class="si">%s</span><span class="s2">!&quot;</span><span class="p">,</span>
                    <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stations</span><span class="p">))</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">test_dir</span><span class="p">,</span> <span class="s1">&#39;eecra_test_stations.dat&#39;</span><span class="p">),</span>
                       <span class="n">eecra_task</span><span class="o">.</span><span class="n">eecra_stations</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%i</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">eecra_task</span><span class="o">.</span><span class="n">init_from_scratch</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">ghcn_task</span><span class="o">.</span><span class="n">raw_src_files</span><span class="p">:</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">fname</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                                   <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">test_dir</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">osp</span><span class="o">.</span><span class="n">samefile</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">make_archive</span><span class="p">(</span><span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">test_dir</span><span class="p">,</span> <span class="s1">&#39;ghcn&#39;</span><span class="p">,</span> <span class="s1">&#39;ghcnd_all&#39;</span><span class="p">),</span>
                                <span class="s1">&#39;gztar&#39;</span><span class="p">,</span>
                                <span class="n">root_dir</span><span class="o">=</span><span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">test_dir</span><span class="p">,</span> <span class="s1">&#39;ghcn&#39;</span><span class="p">),</span>
                                <span class="n">base_dir</span><span class="o">=</span><span class="s1">&#39;ghcnd_all&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">no_cloud</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">eecra_task</span><span class="o">.</span><span class="n">src_files</span><span class="p">:</span>
                <span class="n">target</span> <span class="o">=</span> <span class="n">fname</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                                       <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">test_dir</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">reduce_eecra</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">osp</span><span class="o">.</span><span class="n">samefile</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">keep_all</span><span class="p">:</span>
                        <span class="n">df_bool</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span>
                            <span class="p">[</span><span class="s1">&#39;station_id&#39;</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">,</span> <span class="s1">&#39;day&#39;</span><span class="p">])[[</span>
                                <span class="s1">&#39;ww&#39;</span><span class="p">,</span> <span class="s1">&#39;AT&#39;</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">]]</span>
                        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df_bool</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                            <span class="n">df_bool</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_bool</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
                        <span class="n">g</span> <span class="o">=</span> <span class="n">df_bool</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;station_id&#39;</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">])</span>
                        <span class="n">mask</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">is_complete</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

                    <span class="n">g</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;station_id&#39;</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">],</span>
                                   <span class="n">as_index</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                    <span class="n">tot</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">ngroups</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">tot</span> <span class="o">*</span> <span class="p">(</span><span class="mi">100</span> <span class="o">-</span> <span class="n">reduce_eecra</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
                    <span class="n">idx_groups</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="n">tot</span><span class="p">)[:</span><span class="n">n</span><span class="p">]))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s1">&#39;Saving EECRA test sample with </span><span class="si">%i</span><span class="s1"> years from </span><span class="si">%i</span><span class="s1"> to &#39;</span>
                        <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">tot</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
                    <span class="n">df</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                    <span class="n">igrp</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">idx_groups</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">g</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">igrp</span><span class="p">:</span>
                            <span class="n">group</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span>
                                         <span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                            <span class="n">igrp</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">idx_groups</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span></div>
    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># ------------------------------- Run -------------------------------------</span>
    <span class="c1"># --------------------------- Run the experiment --------------------------</span>
    <span class="c1"># -------------------------------------------------------------------------</span>

    <span class="nd">@docstrings.get_sectionsf</span><span class="p">(</span><span class="s1">&#39;GWGENOrganizer.run&#39;</span><span class="p">)</span>
    <span class="nd">@docstrings.dedent</span>
<div class="viewcode-block" id="GWGENOrganizer.run"><a class="viewcode-back" href="../../api/gwgen.main.html#gwgen.main.GWGENOrganizer.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ifile</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">ofile</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">odir</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">work_dir</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">remove</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run the experiment</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ifile: str</span>
<span class="sd">            The path to the input file. If None, it is assumed that it is</span>
<span class="sd">            stored in the ``&#39;input&#39;`` key in the experiment configuration</span>
<span class="sd">        ofile: str</span>
<span class="sd">            The path to the output file.  If None, it is assumed that it is</span>
<span class="sd">            stored in the ``&#39;input&#39;`` key in the experiment configuration or</span>
<span class="sd">            it will be stored in ``&#39;odir/exp_id.csv&#39;``. The output directory</span>
<span class="sd">            ``&#39;odir&#39;`` is determined by the `odir` parameter</span>
<span class="sd">        odir: str</span>
<span class="sd">            The path to the output directory. If None and not already saved</span>
<span class="sd">            in the configuration, it will default to</span>
<span class="sd">            ``&#39;experiment_dir/outdata&#39;``</span>
<span class="sd">        work_dir: str</span>
<span class="sd">            The path to the work directory where the binaries are copied to.</span>
<span class="sd">        remove: bool</span>
<span class="sd">            If True, the `work_dir` will be removed if it already exists</span>

<span class="sd">        Other Parameters</span>
<span class="sd">        ----------------</span>
<span class="sd">        ``**kwargs``</span>
<span class="sd">            Will be passed to the :meth:`main` method</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">subprocess</span> <span class="kn">as</span> <span class="nn">spr</span>
        <span class="kn">import</span> <span class="nn">stat</span>
        <span class="kn">import</span> <span class="nn">f90nml</span>
        <span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app_main</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span>
        <span class="n">exp_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_paths</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="p">)</span>
        <span class="n">project_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_paths</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_config</span><span class="p">)</span>
        <span class="n">experiment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">{</span><span class="s1">&#39;compile_model&#39;</span><span class="p">,</span> <span class="s1">&#39;compile&#39;</span><span class="p">}</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span>
                <span class="n">project_config</span><span class="p">[</span><span class="s1">&#39;timestamps&#39;</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compile_model</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Running experiment </span><span class="si">%s</span><span class="s2"> of project </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">experiment</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">projectname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ifile</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">ifile</span> <span class="o">=</span> <span class="n">exp_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s1">&#39;input&#39;</span><span class="p">,</span>  <span class="bp">self</span><span class="o">.</span><span class="n">global_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">ifile</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No input file specified!&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ofile</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">ofile</span> <span class="o">=</span> <span class="n">exp_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;outdata&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ofile</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">ofile</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">odir</span> <span class="ow">or</span> <span class="n">exp_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="s1">&#39;outdir&#39;</span><span class="p">,</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">exp_config</span><span class="p">[</span><span class="s1">&#39;expdir&#39;</span><span class="p">],</span> <span class="s1">&#39;outdata&#39;</span><span class="p">)),</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">experiment</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.csv&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">work_dir</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">work_dir</span> <span class="o">=</span> <span class="n">exp_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;workdir&#39;</span><span class="p">,</span>
                                      <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">exp_config</span><span class="p">[</span><span class="s1">&#39;expdir&#39;</span><span class="p">],</span> <span class="s1">&#39;work&#39;</span><span class="p">))</span>
        <span class="n">exp_config</span><span class="p">[</span><span class="s1">&#39;outdir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">odir</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">ofile</span><span class="p">)</span>
        <span class="n">exp_config</span><span class="p">[</span><span class="s1">&#39;outdata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ofile</span>
        <span class="n">exp_config</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ifile</span>
        <span class="n">exp_config</span><span class="p">[</span><span class="s1">&#39;indir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">ifile</span><span class="p">)</span>
        <span class="n">exp_config</span><span class="p">[</span><span class="s1">&#39;workdir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">work_dir</span>
        <span class="n">nml</span> <span class="o">=</span> <span class="n">exp_config</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span>
            <span class="s1">&#39;namelist&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;weathergen_ctl&#39;</span><span class="p">:</span> <span class="n">OrderedDict</span><span class="p">(),</span>
                         <span class="s1">&#39;main_ctl&#39;</span><span class="p">:</span> <span class="n">OrderedDict</span><span class="p">()})</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;weathergen_ctl&#39;</span><span class="p">,</span> <span class="s1">&#39;main_ctl&#39;</span><span class="p">]:</span>
            <span class="n">nml</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">{})</span>

        <span class="k">if</span> <span class="n">osp</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">work_dir</span><span class="p">)</span> <span class="ow">and</span> <span class="n">remove</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">work_dir</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">osp</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">work_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">work_dir</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">osp</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">odir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">odir</span><span class="p">)</span>

        <span class="n">f</span> <span class="o">=</span> <span class="n">project_config</span><span class="p">[</span><span class="s1">&#39;bin&#39;</span><span class="p">]</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="n">osp</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Copy executable </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IXUSR</span> <span class="o">|</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IRUSR</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;    Name list: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ordered_yaml_dump</span><span class="p">(</span><span class="n">nml</span><span class="p">))</span>
        <span class="n">nml</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">nml</span><span class="p">)</span>
        <span class="c1"># transpose multidimensional arrays because they get transposed by</span>
        <span class="c1"># f90nml. Otherwise you get errors using functions like matmul</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">sub_nml</span> <span class="ow">in</span> <span class="n">nml</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">key2</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">sub_nml</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">sub_nml</span><span class="p">[</span><span class="n">key2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="mi">8</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="s1">&#39;weathergen.nml&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f90nml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">nml</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Running experiment...&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;    input: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ifile</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;    output: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ofile</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">commands</span> <span class="o">=</span> <span class="s1">&#39;cd </span><span class="si">%s</span><span class="s1"> &amp;&amp; </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">ifile</span><span class="p">,</span> <span class="n">ofile</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">commands</span><span class="p">)</span>
        <span class="n">spr</span><span class="o">.</span><span class="n">check_call</span><span class="p">(</span><span class="n">commands</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span>
                       <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">err_msg</span> <span class="o">=</span> <span class="s2">&quot;Failed to run the experiment with &#39;</span><span class="si">%s</span><span class="s2">&#39;!&quot;</span> <span class="o">%</span> <span class="n">commands</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">osp</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">ofile</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="p">(</span><span class="n">err_msg</span> <span class="o">+</span> <span class="s2">&quot;Reason: Output </span><span class="si">%s</span><span class="s2"> missing&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ofile</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># check if the file contains more than one line</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ofile</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span> <span class="o">==</span> <span class="n">os</span><span class="o">.</span><span class="n">fstat</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">fileno</span><span class="p">())</span><span class="o">.</span><span class="n">st_size</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">err_msg</span> <span class="o">+</span> <span class="s2">&quot;Reason: Output </span><span class="si">%s</span><span class="s2"> is empty&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ofile</span><span class="p">)))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Done. Time needed: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_modify_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">):</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">update_arg</span><span class="p">(</span><span class="s1">&#39;ifile&#39;</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="s1">&#39;i&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">update_arg</span><span class="p">(</span><span class="s1">&#39;ofile&#39;</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">update_arg</span><span class="p">(</span><span class="s1">&#39;odir&#39;</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="s1">&#39;od&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">update_arg</span><span class="p">(</span><span class="s1">&#39;work_dir&#39;</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="s1">&#39;wd&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">update_arg</span><span class="p">(</span><span class="s1">&#39;remove&#39;</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># -------------------------- Postprocessing -------------------------------</span>
    <span class="c1"># ------------ Postprocessing functions for the experiment ----------------</span>
    <span class="c1"># -------------------------------------------------------------------------</span>

    <span class="c1"># ---------------------------- Evaluation ---------------------------------</span>

    <span class="nd">@docstrings.get_sectionsf</span><span class="p">(</span><span class="s1">&#39;GWGENOrganizer.evaluate&#39;</span><span class="p">)</span>
    <span class="nd">@docstrings.dedent</span>
<div class="viewcode-block" id="GWGENOrganizer.evaluate"><a class="viewcode-back" href="../../api/gwgen.main.html#gwgen.main.GWGENOrganizer.evaluate">[docs]</a>    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stations</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">other_exp</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">setup_from</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">to_db</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">to_csv</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">database</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">norun</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">to_return</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">complete</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Evaluate the experiment</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        %(GWGENOrganizer.param.parameters)s&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">gwgen.evaluation</span> <span class="kn">import</span> <span class="n">Evaluator</span>
        <span class="n">task_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">task</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">Evaluator</span><span class="o">.</span><span class="n">_registry</span><span class="p">]</span>
        <span class="n">evaluator_kws</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">key</span><span class="p">:</span> <span class="nb">vars</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">Namespace</span><span class="p">)</span> <span class="k">else</span> <span class="nb">dict</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">task_names</span><span class="p">}</span>
        <span class="n">main_kws</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">val</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">task_names</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app_main</span><span class="p">(</span><span class="o">**</span><span class="n">main_kws</span><span class="p">)</span>
        <span class="n">experiment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span>
        <span class="n">exp_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_paths</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">experiments</span><span class="p">[</span><span class="n">experiment</span><span class="p">])</span>
        <span class="n">eval_dir</span> <span class="o">=</span> <span class="n">exp_dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span>
            <span class="s1">&#39;evaldir&#39;</span><span class="p">,</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">exp_dict</span><span class="p">[</span><span class="s1">&#39;expdir&#39;</span><span class="p">],</span> <span class="s1">&#39;evaluation&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">osp</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">eval_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">eval_dir</span><span class="p">)</span>
        <span class="n">projectname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">projectname</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Evaluating experiment </span><span class="si">%s</span><span class="s2"> of project </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">experiment</span><span class="p">,</span> <span class="n">projectname</span><span class="p">)</span>
        <span class="n">stations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_stations</span><span class="p">(</span><span class="n">stations</span><span class="p">,</span> <span class="n">other_exp</span><span class="p">,</span> <span class="n">eval_dir</span><span class="p">,</span>
                                      <span class="s1">&#39;eval_stations&#39;</span><span class="p">)</span>
        <span class="n">global_conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">global_config</span>
        <span class="c1"># choose keywords for data processing</span>
        <span class="n">manager</span> <span class="o">=</span> <span class="n">Evaluator</span><span class="o">.</span><span class="n">get_manager</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">global_conf</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_manager</span><span class="p">(</span><span class="n">manager</span><span class="p">,</span> <span class="n">stations</span><span class="p">,</span> <span class="n">other_exp</span><span class="p">,</span> <span class="n">setup_from</span><span class="p">,</span> <span class="n">to_db</span><span class="p">,</span>
                            <span class="n">to_csv</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="n">to_return</span><span class="p">,</span> <span class="n">complete</span><span class="p">,</span>
                            <span class="n">evaluator_kws</span><span class="p">)</span>
        <span class="c1"># update experiment namelist and configuration</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">norun</span><span class="p">:</span>
            <span class="n">manager</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">exp_dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;evaluation&#39;</span><span class="p">,</span> <span class="n">OrderedDict</span><span class="p">()))</span>
        <span class="k">return</span> <span class="n">manager</span></div>

    <span class="k">def</span> <span class="nf">_modify_evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">gwgen.evaluation</span> <span class="kn">import</span> <span class="n">Evaluator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_modify_task_parser</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">Evaluator</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bias_correction_methods</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;wind&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">wind_bias_correction</span><span class="p">,</span>
                <span class="s1">&#39;tmin&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmin_bias_correction</span><span class="p">}</span>

    <span class="nd">@docstrings.dedent</span>
<div class="viewcode-block" id="GWGENOrganizer.bias_correction"><a class="viewcode-back" href="../../api/gwgen.main.html#gwgen.main.GWGENOrganizer.bias_correction">[docs]</a>    <span class="k">def</span> <span class="nf">bias_correction</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">quantiles</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)),</span>
            <span class="n">no_evaluation</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">new_project</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform a bias correction for the data</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        keep: bool</span>
<span class="sd">            If not True, the experiment configuration files are not modified.</span>
<span class="sd">            Otherwise the `quants` section is kept for the given quantiles</span>
<span class="sd">        quantiles: list of float</span>
<span class="sd">            The quantiles to use for the bias correction. Does not have an</span>
<span class="sd">            effect if `no_evaluation` is set to True</span>
<span class="sd">        no_evaluation: bool</span>
<span class="sd">            If True, the existing evaluation in the configuration is used for</span>
<span class="sd">            the bias correction</span>
<span class="sd">        new_project: bool</span>
<span class="sd">            If True, a new project will be created even if a file in</span>
<span class="sd">            `project_output` exists already</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            The results of the underlying bias correction methods&quot;&quot;&quot;</span>
        <span class="n">methods</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_correction_methods</span>

        <span class="n">main_kws</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_app_main_kwargs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">bias_kws</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">key</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">methods</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">app_main</span><span class="p">(</span><span class="o">**</span><span class="n">main_kws</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Calculating bias correction for experiment </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="p">)</span>
        <span class="n">old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;evaluation&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;quants&#39;</span><span class="p">)</span>
        <span class="n">postproc_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span>
            <span class="s1">&#39;postprocdir&#39;</span><span class="p">,</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="p">[</span><span class="s1">&#39;expdir&#39;</span><span class="p">],</span> <span class="s1">&#39;postproc&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">osp</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">postproc_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">postproc_dir</span><span class="p">)</span>
        <span class="n">quants_output</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">postproc_dir</span><span class="p">,</span> <span class="s1">&#39;quants_bias&#39;</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;quants&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;quantiles&#39;</span><span class="p">:</span> <span class="n">quantiles</span><span class="p">,</span> <span class="s1">&#39;transform_wind&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
                            <span class="s1">&#39;new_project&#39;</span><span class="p">:</span> <span class="n">new_project</span><span class="p">,</span>
                            <span class="s1">&#39;names&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">bias_kws</span><span class="p">),</span>
                            <span class="s1">&#39;project_output&#39;</span><span class="p">:</span> <span class="n">quants_output</span> <span class="o">+</span> <span class="s1">&#39;.pkl&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;plot_output&#39;</span><span class="p">:</span> <span class="n">quants_output</span> <span class="o">+</span> <span class="s1">&#39;.pdf&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;nc_output&#39;</span><span class="p">:</span> <span class="n">quants_output</span> <span class="o">+</span> <span class="s1">&#39;.nc&#39;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;postproc&#39;</span><span class="p">,</span> <span class="n">OrderedDict</span><span class="p">())</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span>
            <span class="s1">&#39;bias&#39;</span><span class="p">,</span> <span class="n">OrderedDict</span><span class="p">())</span>

        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;plot_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">quants_output</span> <span class="o">+</span> <span class="s1">&#39;.pdf&#39;</span>
        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;project_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">quants_output</span> <span class="o">+</span> <span class="s1">&#39;.pkl&#39;</span>
        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;nc_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">quants_output</span> <span class="o">+</span> <span class="s1">&#39;.nc&#39;</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">kws</span> <span class="ow">in</span> <span class="n">bias_kws</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kws</span><span class="p">,</span> <span class="n">Namespace</span><span class="p">):</span>
                <span class="n">kws</span> <span class="o">=</span> <span class="nb">vars</span><span class="p">(</span><span class="n">kws</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;keep&#39;</span><span class="p">,</span> <span class="s1">&#39;quantiles&#39;</span><span class="p">,</span> <span class="s1">&#39;no_evaluation&#39;</span><span class="p">]:</span>
                    <span class="n">kws</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">methods</span><span class="p">[</span><span class="n">name</span><span class="p">](</span><span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="p">[</span><span class="s1">&#39;evaluation&#39;</span><span class="p">][</span><span class="s1">&#39;quants&#39;</span><span class="p">],</span> <span class="o">**</span><span class="n">kws</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">keep</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">old</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="p">[</span><span class="s1">&#39;evaluation&#39;</span><span class="p">][</span><span class="s1">&#39;quants&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">old</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="p">[</span><span class="s1">&#39;evaluation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;quants&#39;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_modify_bias_correction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_modify_app_main</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">update_arg</span><span class="p">(</span><span class="s1">&#39;keep&#39;</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">update_arg</span><span class="p">(</span>
            <span class="s1">&#39;quantiles&#39;</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">utils</span><span class="o">.</span><span class="n">str_ranges</span><span class="p">,</span>
            <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;f1[,f21[-f22[-f23]]]&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">docstrings</span><span class="o">.</span><span class="n">dedents</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                The quantiles to use for calculating the percentiles.</span>
<span class="s2">                %(str_ranges.s_help)s.&quot;&quot;&quot;</span><span class="p">))</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">pop_key</span><span class="p">(</span><span class="s1">&#39;quantiles&#39;</span><span class="p">,</span> <span class="s1">&#39;nargs&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">update_arg</span><span class="p">(</span><span class="s1">&#39;new_project&#39;</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="s1">&#39;np&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">update_arg</span><span class="p">(</span><span class="s1">&#39;no_evaluation&#39;</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="s1">&#39;ne&#39;</span><span class="p">)</span>

        <span class="n">sps</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_subparsers</span><span class="p">(</span><span class="n">chain</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="c1"># -- wind</span>
        <span class="n">sp</span> <span class="o">=</span> <span class="n">sps</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s1">&#39;wind&#39;</span><span class="p">)</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">setup_args</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wind_bias_correction_logistic</span><span class="p">)</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">setup_args</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wind_bias_correction</span><span class="p">)</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">update_arg</span><span class="p">(</span><span class="s1">&#39;new_project&#39;</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="s1">&#39;np&#39;</span><span class="p">)</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">update_arg</span><span class="p">(</span><span class="s1">&#39;plot_output&#39;</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="s1">&#39;po&#39;</span><span class="p">)</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">pop_arg</span><span class="p">(</span><span class="s1">&#39;info&#39;</span><span class="p">)</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">pop_arg</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">)</span>

        <span class="c1"># -- tmin</span>
        <span class="n">sp</span> <span class="o">=</span> <span class="n">sps</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s1">&#39;tmin&#39;</span><span class="p">)</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">setup_args</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">poly_bias_correction</span><span class="p">)</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">pop_arg</span><span class="p">(</span><span class="s1">&#39;vname&#39;</span><span class="p">)</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">pop_arg</span><span class="p">(</span><span class="s1">&#39;what&#39;</span><span class="p">)</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">pop_arg</span><span class="p">(</span><span class="s1">&#39;ds&#39;</span><span class="p">)</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">setup_args</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmin_bias_correction</span><span class="p">)</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">update_arg</span><span class="p">(</span><span class="s1">&#39;new_project&#39;</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="s1">&#39;np&#39;</span><span class="p">)</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">update_arg</span><span class="p">(</span><span class="s1">&#39;plot_output&#39;</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="s1">&#39;po&#39;</span><span class="p">)</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">pop_arg</span><span class="p">(</span><span class="s1">&#39;info&#39;</span><span class="p">)</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">pop_arg</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">)</span>

    <span class="nd">@docstrings.get_sectionsf</span><span class="p">(</span><span class="s1">&#39;GWGENOrganizer.wind_bias_correction_logistic&#39;</span><span class="p">)</span>
    <span class="nd">@docstrings.dedent</span>
<div class="viewcode-block" id="GWGENOrganizer.wind_bias_correction_logistic"><a class="viewcode-back" href="../../api/gwgen.main.html#gwgen.main.GWGENOrganizer.wind_bias_correction_logistic">[docs]</a>    <span class="k">def</span> <span class="nf">wind_bias_correction_logistic</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">new_project</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">plot_output</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">close</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform a bias correction for the data</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        info: dict</span>
<span class="sd">            The configuration of the quantile evaluation</span>
<span class="sd">        new_project: bool</span>
<span class="sd">            If True, a new project will be created even if a file in</span>
<span class="sd">            `project_output` exists already</span>
<span class="sd">        plot_output: str</span>
<span class="sd">            The name of the output file. If not specified, it defaults to</span>
<span class="sd">            `&lt;exp_dir&gt;/postproc/&lt;vname&gt;_bias_correction.pdf`</span>
<span class="sd">        close: bool</span>
<span class="sd">            If True, close the project at the end&quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
        <span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
        <span class="kn">import</span> <span class="nn">xarray</span> <span class="kn">as</span> <span class="nn">xr</span>
        <span class="kn">import</span> <span class="nn">psyplot.project</span> <span class="kn">as</span> <span class="nn">psy</span>

        <span class="n">vname</span> <span class="o">=</span> <span class="s1">&#39;wind&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Calculating bias correction for experiment </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="p">)</span>
        <span class="n">postproc_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span>
            <span class="s1">&#39;postprocdir&#39;</span><span class="p">,</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="p">[</span><span class="s1">&#39;expdir&#39;</span><span class="p">],</span> <span class="s1">&#39;postproc&#39;</span><span class="p">))</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="n">vname</span><span class="p">],</span> <span class="s1">&#39;index&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># drop all percentiles</span>
            <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;All&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;pctl&#39;</span>
        <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;unorm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;pctl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> <span class="o">/</span> <span class="mf">100.</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">from_dataframe</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="c1"># --- plots</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;postproc&#39;</span><span class="p">,</span> <span class="n">OrderedDict</span><span class="p">())</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span>
            <span class="s1">&#39;bias&#39;</span><span class="p">,</span> <span class="n">OrderedDict</span><span class="p">())</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">vname</span><span class="p">,</span> <span class="n">OrderedDict</span><span class="p">())</span>
        <span class="n">plot_output</span> <span class="o">=</span> <span class="n">plot_output</span> <span class="ow">or</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;plot_output&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">plot_output</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">plot_output</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">postproc_dir</span><span class="p">,</span> <span class="n">vname</span> <span class="o">+</span> <span class="s1">&#39;_bias_correction.pdf&#39;</span><span class="p">)</span>

        <span class="n">project_output</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">plot_output</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.pkl&#39;</span>
        <span class="n">nc_output</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">plot_output</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.nc&#39;</span>

        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;plot_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plot_output</span>
        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;project_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">project_output</span>
        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;nc_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nc_output</span>

        <span class="c1"># --- slope bias correction</span>
        <span class="k">if</span> <span class="n">osp</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">project_output</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">new_project</span><span class="p">:</span>
            <span class="n">mp</span> <span class="o">=</span> <span class="n">psy</span><span class="o">.</span><span class="n">Project</span><span class="o">.</span><span class="n">load_project</span><span class="p">(</span><span class="n">project_output</span><span class="p">,</span> <span class="n">datasets</span><span class="o">=</span><span class="p">[</span><span class="n">ds</span><span class="p">])</span>
            <span class="n">sp2</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">linreg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;slope&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">seaborn</span> <span class="kn">as</span> <span class="nn">sns</span>
            <span class="n">sns</span><span class="o">.</span><span class="n">set_style</span><span class="p">(</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
            <span class="n">sp1</span> <span class="o">=</span> <span class="n">psy</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;slope&#39;</span><span class="p">,</span> <span class="n">coord</span><span class="o">=</span><span class="s1">&#39;unorm&#39;</span><span class="p">,</span>
                                    <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">sp2</span> <span class="o">=</span> <span class="n">psy</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">linreg</span><span class="p">(</span>
                 <span class="n">ds</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;slope&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">sp1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">psy</span><span class="o">.</span><span class="n">ax</span><span class="p">,</span>
                 <span class="n">coord</span><span class="o">=</span><span class="s1">&#39;unorm&#39;</span><span class="p">,</span> <span class="n">fit</span><span class="o">=</span><span class="n">logistic_function</span><span class="p">,</span>
                 <span class="n">ylabel</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;$</span><span class="se">\\</span><span class="s1">mathrm{{Simulated}}</span><span class="se">\\</span><span class="s1">, </span><span class="se">\\</span><span class="s1">mathrm{{</span><span class="si">%s</span><span class="s1">}} / &#39;</span>
                         <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">mathrm{{Observed}}</span><span class="se">\\</span><span class="s1">, </span><span class="se">\\</span><span class="s1">mathrm{{</span><span class="si">%s</span><span class="s1">}}$&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">vname</span><span class="p">,</span> <span class="n">vname</span><span class="p">),</span>
                 <span class="n">legendlabels</span><span class="o">=</span><span class="p">(</span>
                     <span class="s1">&#39;$</span><span class="se">\\</span><span class="s1">frac{{</span><span class="se">\\</span><span class="s1">mathrm{{Simulated}}}}&#39;</span>
                     <span class="s1">&#39;{{</span><span class="se">\\</span><span class="s1">mathrm{{Observed}}}} = &#39;</span>
                     <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">frac{{</span><span class="si">%(L)4.3f</span><span class="s1">}}{{1 + </span><span class="se">\\</span><span class="s1">mathrm{{e}}^{{&#39;</span>
                     <span class="s1">&#39;</span><span class="si">%(k)4.3f</span><span class="se">\\</span><span class="s1">cdot(x </span><span class="si">%(x0)+4.3f</span><span class="s1">)}}}}$&#39;</span><span class="p">),</span>
                 <span class="n">legend</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;fontsize&#39;</span><span class="p">:</span> <span class="s1">&#39;x-large&#39;</span><span class="p">,</span> <span class="s1">&#39;loc&#39;</span><span class="p">:</span> <span class="s1">&#39;upper left&#39;</span><span class="p">},</span>
                 <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Random number $x$ from normal distribution&#39;</span><span class="p">)</span>
            <span class="n">sp2</span><span class="o">.</span><span class="n">share</span><span class="p">(</span><span class="n">sp1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="s1">&#39;xlim&#39;</span><span class="p">,</span> <span class="s1">&#39;ylim&#39;</span><span class="p">])</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">sp2</span><span class="o">.</span><span class="n">plotters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">nml</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="p">[</span><span class="s1">&#39;namelist&#39;</span><span class="p">][</span><span class="s1">&#39;weathergen_ctl&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;L&#39;</span> <span class="ow">in</span> <span class="n">arr</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
            <span class="n">nml</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">vname</span> <span class="o">+</span> <span class="s1">&#39;_bias_coeffs&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">letter</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="s1">&#39;x0&#39;</span><span class="p">]:</span>
                <span class="n">nml</span><span class="p">[</span><span class="n">vname</span> <span class="o">+</span> <span class="s1">&#39;_slope_bias_&#39;</span> <span class="o">+</span> <span class="n">letter</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">letter</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># polynomial fit</span>
            <span class="k">for</span> <span class="n">letter</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="s1">&#39;x0&#39;</span><span class="p">]:</span>
                <span class="n">nml</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">vname</span> <span class="o">+</span> <span class="s1">&#39;_slope_bias_&#39;</span> <span class="o">+</span> <span class="n">letter</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">nml</span><span class="p">[</span><span class="n">vname</span> <span class="o">+</span> <span class="s1">&#39;_bias_coeffs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="nb">float</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;c</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)]</span>

        <span class="c1"># --- intercept bias correction</span>
        <span class="k">if</span> <span class="n">osp</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">project_output</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">new_project</span><span class="p">:</span>
            <span class="n">sp2</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">linreg</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;intercept&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sp1</span> <span class="o">=</span> <span class="n">psy</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;intercept&#39;</span><span class="p">,</span> <span class="n">coord</span><span class="o">=</span><span class="s1">&#39;unorm&#39;</span><span class="p">,</span>
                                    <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">sp2</span> <span class="o">=</span> <span class="n">psy</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">linreg</span><span class="p">(</span>
                 <span class="n">ds</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;intercept&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">sp1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">psy</span><span class="o">.</span><span class="n">ax</span><span class="p">,</span>
                 <span class="n">coord</span><span class="o">=</span><span class="s1">&#39;unorm&#39;</span><span class="p">,</span> <span class="n">fit</span><span class="o">=</span><span class="n">exponential_function</span><span class="p">,</span>
                 <span class="n">ylabel</span><span class="o">=</span><span class="p">(</span>
                    <span class="s1">&#39;$</span><span class="se">\\</span><span class="s1">mathrm{{Simulated}}</span><span class="se">\\</span><span class="s1">, </span><span class="se">\\</span><span class="s1">mathrm{{</span><span class="si">%s</span><span class="s1">}} - &#39;</span>
                    <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">mathrm{{Observed}}</span><span class="se">\\</span><span class="s1">, </span><span class="se">\\</span><span class="s1">mathrm{{</span><span class="si">%s</span><span class="s1">}}$ [m/s]&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">vname</span><span class="p">,</span> <span class="n">vname</span><span class="p">),</span>
                 <span class="n">legendlabels</span><span class="o">=</span><span class="p">(</span>
                     <span class="s1">&#39;$</span><span class="se">\\</span><span class="s1">mathrm{{Simulated}} - </span><span class="se">\\</span><span class="s1">mathrm{{Observed}} =&#39;</span>
                     <span class="s1">&#39;e^{{</span><span class="si">%(a)1.4f</span><span class="s1"> </span><span class="se">\\</span><span class="s1">cdot x </span><span class="si">%(b)+1.4f</span><span class="s1">}}$&#39;</span><span class="p">),</span>
                 <span class="n">legend</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;fontsize&#39;</span><span class="p">:</span> <span class="s1">&#39;medium&#39;</span><span class="p">,</span> <span class="s1">&#39;loc&#39;</span><span class="p">:</span> <span class="s1">&#39;upper left&#39;</span><span class="p">},</span>
                 <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Random number $x$ from normal distribution&#39;</span><span class="p">)</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">sp2</span><span class="o">.</span><span class="n">plotters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;a&#39;</span> <span class="ow">in</span> <span class="n">arr</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
            <span class="n">nml</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">vname</span> <span class="o">+</span> <span class="s1">&#39;_intercept_bias_coeffs&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">letter</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">]:</span>
                <span class="n">nml</span><span class="p">[</span><span class="n">vname</span> <span class="o">+</span> <span class="s1">&#39;_intercept_bias_&#39;</span> <span class="o">+</span> <span class="n">letter</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
                    <span class="n">arr</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">letter</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># polynomial fit</span>
            <span class="k">for</span> <span class="n">letter</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">]:</span>
                <span class="n">nml</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">vname</span> <span class="o">+</span> <span class="s1">&#39;_intercept_bias_&#39;</span> <span class="o">+</span> <span class="n">letter</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">nml</span><span class="p">[</span><span class="n">vname</span> <span class="o">+</span> <span class="s1">&#39;_intercept_bias_coeffs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="nb">float</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;c</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)]</span>
        <span class="n">nml</span><span class="p">[</span><span class="n">vname</span> <span class="o">+</span> <span class="s1">&#39;_bias_min&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">unorm</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">nml</span><span class="p">[</span><span class="n">vname</span> <span class="o">+</span> <span class="s1">&#39;_bias_max&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">unorm</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="c1"># --- save the data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Saving plots to </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">plot_output</span><span class="p">)</span>
        <span class="n">mp</span> <span class="o">=</span> <span class="n">psy</span><span class="o">.</span><span class="n">gcp</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">mp</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">plot_output</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Saving project to </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">project_output</span><span class="p">)</span>
        <span class="n">mp</span><span class="o">.</span><span class="n">save_project</span><span class="p">(</span><span class="n">project_output</span><span class="p">,</span> <span class="n">paths</span><span class="o">=</span><span class="p">[</span><span class="n">nc_output</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">close</span><span class="p">:</span>
            <span class="n">psy</span><span class="o">.</span><span class="n">gcp</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span></div>

    <span class="nd">@docstrings.get_sectionsf</span><span class="p">(</span><span class="s1">&#39;GWGENOrganizer.poly_bias_correction&#39;</span><span class="p">)</span>
    <span class="nd">@docstrings.dedent</span>
<div class="viewcode-block" id="GWGENOrganizer.poly_bias_correction"><a class="viewcode-back" href="../../api/gwgen.main.html#gwgen.main.GWGENOrganizer.poly_bias_correction">[docs]</a>    <span class="k">def</span> <span class="nf">poly_bias_correction</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">vname</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">new_project</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">plot_output</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">deg</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">close</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">ds</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform a bias correction based on percentile and a polynomial fit</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        vname: str</span>
<span class="sd">            The variable name to use</span>
<span class="sd">        what: str { &#39;slope&#39; | &#39;intercept&#39; }</span>
<span class="sd">            Either slope or intercept. The parameter that should be used for</span>
<span class="sd">            the bias correction</span>
<span class="sd">        info: dict</span>
<span class="sd">            The configuration of the quantile evaluation</span>
<span class="sd">        new_project: bool</span>
<span class="sd">            If True, a new project will be created even if a file in</span>
<span class="sd">            `project_output` exists already</span>
<span class="sd">        plot_output: str</span>
<span class="sd">            The name of the output file. If not specified, it defaults to</span>
<span class="sd">            `&lt;exp_dir&gt;/postproc/&lt;vname&gt;_bias_correction.pdf`</span>
<span class="sd">        deg: int</span>
<span class="sd">            The degree of the fittet polynomial</span>
<span class="sd">        close: bool</span>
<span class="sd">            If True, close the project at the end</span>
<span class="sd">        ds: xr.Dataset</span>
<span class="sd">            The xarray dataset to use. Otherwise it will be created from `info`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
        <span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
        <span class="kn">import</span> <span class="nn">xarray</span> <span class="kn">as</span> <span class="nn">xr</span>
        <span class="kn">import</span> <span class="nn">psyplot.project</span> <span class="kn">as</span> <span class="nn">psy</span>

        <span class="k">def</span> <span class="nf">get_symbol</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;&#39;</span>
            <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;x&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;x^&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Calculating </span><span class="si">%s</span><span class="s1"> bias correction for experiment </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                          <span class="n">vname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="p">)</span>
        <span class="n">postproc_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span>
            <span class="s1">&#39;postprocdir&#39;</span><span class="p">,</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="p">[</span><span class="s1">&#39;expdir&#39;</span><span class="p">],</span> <span class="s1">&#39;postproc&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">ds</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="n">vname</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># drop all percentiles</span>
                <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;All&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;pctl&#39;</span>
            <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;unorm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;pctl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> <span class="o">/</span> <span class="mf">100.</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">from_dataframe</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="c1"># --- plots</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;postproc&#39;</span><span class="p">,</span> <span class="n">OrderedDict</span><span class="p">())</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span>
            <span class="s1">&#39;bias&#39;</span><span class="p">,</span> <span class="n">OrderedDict</span><span class="p">())</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">vname</span><span class="p">,</span> <span class="n">OrderedDict</span><span class="p">())</span>
        <span class="n">plot_output</span> <span class="o">=</span> <span class="n">plot_output</span> <span class="ow">or</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;plot_output&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">plot_output</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">plot_output</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">postproc_dir</span><span class="p">,</span> <span class="n">vname</span> <span class="o">+</span> <span class="s1">&#39;_bias_correction.pdf&#39;</span><span class="p">)</span>

        <span class="n">project_output</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">plot_output</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.pkl&#39;</span>
        <span class="n">nc_output</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">plot_output</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.nc&#39;</span>

        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;plot_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plot_output</span>
        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;project_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">project_output</span>
        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;nc_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nc_output</span>

        <span class="k">if</span> <span class="n">what</span> <span class="o">==</span> <span class="s1">&#39;slope&#39;</span><span class="p">:</span>
            <span class="n">ylabel</span> <span class="o">=</span> <span class="s1">&#39;Simulated/Observed&#39;</span>
            <span class="k">if</span> <span class="n">vname</span> <span class="o">==</span> <span class="s1">&#39;wind&#39;</span><span class="p">:</span>
                <span class="n">ylabel</span> <span class="o">=</span> <span class="s1">&#39;$</span><span class="se">\\</span><span class="s1">sqrt{{&#39;</span> <span class="o">+</span> <span class="n">ylabel</span> <span class="o">+</span> <span class="s1">&#39;}}$&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ylabel</span> <span class="o">=</span> <span class="s1">&#39;Simulated - Observed&#39;</span>
        <span class="n">diff_symbol</span> <span class="o">=</span> <span class="n">ylabel</span>
        <span class="k">if</span> <span class="n">vname</span> <span class="o">==</span> <span class="s1">&#39;tmin&#39;</span><span class="p">:</span>
            <span class="n">ylabel</span> <span class="o">+=</span> <span class="s1">&#39; [$^\circ$C]&#39;</span>

        <span class="c1"># --- slope bias correction</span>
        <span class="k">if</span> <span class="n">osp</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">project_output</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">new_project</span><span class="p">:</span>
            <span class="n">mp</span> <span class="o">=</span> <span class="n">psy</span><span class="o">.</span><span class="n">Project</span><span class="o">.</span><span class="n">load_project</span><span class="p">(</span><span class="n">project_output</span><span class="p">,</span> <span class="n">datasets</span><span class="o">=</span><span class="p">[</span><span class="n">ds</span><span class="p">])</span>
            <span class="n">sp2</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">linreg</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">seaborn</span> <span class="kn">as</span> <span class="nn">sns</span>
            <span class="n">sns</span><span class="o">.</span><span class="n">set_style</span><span class="p">(</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
            <span class="n">sp1</span> <span class="o">=</span> <span class="n">psy</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">what</span><span class="p">,</span> <span class="n">coord</span><span class="o">=</span><span class="s1">&#39;unorm&#39;</span><span class="p">,</span>
                                    <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;$</span><span class="si">%s</span><span class="s1"> = </span><span class="si">%s</span><span class="s1">$&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">diff_symbol</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="s1">&#39;%(c{})+4.3f{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">get_symbol</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">deg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>
            <span class="n">sp2</span> <span class="o">=</span> <span class="n">psy</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">linreg</span><span class="p">(</span>
                 <span class="n">ds</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">what</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">sp1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ax</span><span class="p">,</span>
                 <span class="n">coord</span><span class="o">=</span><span class="s1">&#39;unorm&#39;</span><span class="p">,</span> <span class="n">fit</span><span class="o">=</span><span class="s1">&#39;poly&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">deg</span><span class="p">)),</span>
                 <span class="n">ylabel</span><span class="o">=</span><span class="n">ylabel</span><span class="p">,</span>
                 <span class="n">legendlabels</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                 <span class="n">legend</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;fontsize&#39;</span><span class="p">:</span> <span class="s1">&#39;large&#39;</span><span class="p">,</span> <span class="s1">&#39;loc&#39;</span><span class="p">:</span> <span class="s1">&#39;upper left&#39;</span><span class="p">},</span>
                 <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Random number from normal distribution&#39;</span><span class="p">)</span>
            <span class="n">sp2</span><span class="o">.</span><span class="n">share</span><span class="p">(</span><span class="n">sp1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="s1">&#39;xlim&#39;</span><span class="p">,</span> <span class="s1">&#39;ylim&#39;</span><span class="p">])</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="n">sp2</span><span class="o">.</span><span class="n">plotters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span>
        <span class="n">nml</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="p">[</span><span class="s1">&#39;namelist&#39;</span><span class="p">][</span><span class="s1">&#39;weathergen_ctl&#39;</span><span class="p">]</span>
        <span class="n">nml</span><span class="p">[</span><span class="n">vname</span> <span class="o">+</span> <span class="s1">&#39;_bias_coeffs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">float</span><span class="p">(</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;c</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)]</span>
        <span class="n">nml</span><span class="p">[</span><span class="n">vname</span> <span class="o">+</span> <span class="s1">&#39;_bias_min&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">unorm</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">nml</span><span class="p">[</span><span class="n">vname</span> <span class="o">+</span> <span class="s1">&#39;_bias_max&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">unorm</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

        <span class="c1"># --- save the data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Saving plots to </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">plot_output</span><span class="p">)</span>
        <span class="n">mp</span> <span class="o">=</span> <span class="n">psy</span><span class="o">.</span><span class="n">gcp</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">mp</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">plot_output</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Saving project to </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">project_output</span><span class="p">)</span>
        <span class="n">mp</span><span class="o">.</span><span class="n">save_project</span><span class="p">(</span><span class="n">project_output</span><span class="p">,</span> <span class="n">paths</span><span class="o">=</span><span class="p">[</span><span class="n">nc_output</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">close</span><span class="p">:</span>
            <span class="n">psy</span><span class="o">.</span><span class="n">gcp</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span></div>

    <span class="n">docstrings</span><span class="o">.</span><span class="n">delete_params</span><span class="p">(</span><span class="s1">&#39;GWGENOrganizer.poly_bias_correction.parameters&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;vname&#39;</span><span class="p">,</span> <span class="s1">&#39;what&#39;</span><span class="p">)</span>

    <span class="nd">@docstrings.dedent</span>
<div class="viewcode-block" id="GWGENOrganizer.tmin_bias_correction"><a class="viewcode-back" href="../../api/gwgen.main.html#gwgen.main.GWGENOrganizer.tmin_bias_correction">[docs]</a>    <span class="k">def</span> <span class="nf">tmin_bias_correction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform a bias correction for the minimum temperature data</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        %(GWGENOrganizer.poly_bias_correction.parameters.no_vname|what)s&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">poly_bias_correction</span><span class="p">(</span><span class="s1">&#39;tmin&#39;</span><span class="p">,</span> <span class="s1">&#39;intercept&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    <span class="nd">@docstrings.dedent</span>
<div class="viewcode-block" id="GWGENOrganizer.wind_bias_correction"><a class="viewcode-back" href="../../api/gwgen.main.html#gwgen.main.GWGENOrganizer.wind_bias_correction">[docs]</a>    <span class="k">def</span> <span class="nf">wind_bias_correction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform a bias correction for the wind speed</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        %(GWGENOrganizer.wind_bias_correction_logistic.parameters)s&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wind_bias_correction_logistic</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    <span class="c1"># ----------------------- Sensitivity analysis ----------------------------</span>

    <span class="nd">@docstrings.dedent</span>
<div class="viewcode-block" id="GWGENOrganizer.sensitivity_analysis"><a class="viewcode-back" href="../../api/gwgen.main.html#gwgen.main.GWGENOrganizer.sensitivity_analysis">[docs]</a>    <span class="k">def</span> <span class="nf">sensitivity_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform a sensitivity analysis on the given parameters</span>

<span class="sd">        This function performs a sensitivity analysis on the current</span>
<span class="sd">        experiment. It creates a new project and uses the evaluation and</span>
<span class="sd">        parameterization of the current experiment to get information on the</span>
<span class="sd">        others</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">gwgen.sensitivity_analysis</span> <span class="kn">import</span> <span class="n">SensitivityAnalysis</span>
        <span class="n">sa_func_map</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">([</span>
            <span class="p">(</span><span class="s1">&#39;setup&#39;</span><span class="p">,</span> <span class="s1">&#39;setup&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;compile&#39;</span><span class="p">,</span> <span class="s1">&#39;compile_model&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;init&#39;</span><span class="p">,</span> <span class="s1">&#39;init&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;run&#39;</span><span class="p">,</span> <span class="s1">&#39;run&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;evaluate&#39;</span><span class="p">,</span> <span class="s1">&#39;evaluate&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;plot&#39;</span><span class="p">,</span> <span class="s1">&#39;plot&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;remove&#39;</span><span class="p">,</span> <span class="s1">&#39;remove&#39;</span><span class="p">)])</span>
        <span class="n">sensitivity_kws</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span>
            <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">sa_func_map</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">)</span>
        <span class="n">main_kws</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">key</span><span class="p">:</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">sa_func_map</span><span class="p">)}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app_main</span><span class="p">(</span><span class="o">**</span><span class="n">main_kws</span><span class="p">)</span>
        <span class="c1"># to make sure, we already called the choose the right experiment and</span>
        <span class="c1"># projectname</span>
        <span class="n">experiment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Running sensitivity analysis for </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">experiment</span><span class="p">)</span>
        <span class="n">sa</span> <span class="o">=</span> <span class="n">SensitivityAnalysis</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fix_paths</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fix_paths</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_config</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">sensitivity_kws</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">Namespace</span><span class="p">):</span>
                <span class="n">val</span> <span class="o">=</span> <span class="nb">vars</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span> <span class="n">sa_func_map</span><span class="p">[</span><span class="n">key</span><span class="p">])(</span><span class="o">**</span><span class="n">val</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_modify_sensitivity_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">gwgen.sensitivity_analysis</span> <span class="kn">import</span> <span class="p">(</span>
            <span class="n">SensitivityAnalysis</span><span class="p">,</span> <span class="n">SensitivityPlot</span><span class="p">,</span> <span class="n">default_sens_config</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">params_type</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="n">splitted</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">splitted</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">key</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">str_ranges</span><span class="p">(</span><span class="n">splitted</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">sps</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_subparsers</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Sensitivity analysis subroutines&#39;</span><span class="p">,</span>
                                    <span class="n">chain</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="c1"># setup parser</span>
        <span class="n">sp</span> <span class="o">=</span> <span class="n">sps</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s1">&#39;setup&#39;</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Setup the sensitivity analysis model&#39;</span><span class="p">)</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">setup_args</span><span class="p">(</span><span class="n">SensitivityAnalysis</span><span class="o">.</span><span class="n">setup</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_modify_app_main</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">update_arg</span><span class="p">(</span><span class="s1">&#39;no_move&#39;</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="s1">&#39;nm&#39;</span><span class="p">)</span>

        <span class="c1"># compile parser</span>
        <span class="n">sp</span> <span class="o">=</span> <span class="n">sps</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s1">&#39;compile&#39;</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Compile the sensitivity analysis model&#39;</span><span class="p">)</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">setup_args</span><span class="p">(</span><span class="n">SensitivityAnalysis</span><span class="o">.</span><span class="n">compile_model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_modify_compile_model</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>

        <span class="c1"># init parser</span>
        <span class="n">sp</span> <span class="o">=</span> <span class="n">sps</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span>
            <span class="s1">&#39;init&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Initialize the sensitivity analysis experiments&#39;</span><span class="p">)</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">setup_args</span><span class="p">(</span><span class="n">SensitivityAnalysis</span><span class="o">.</span><span class="n">init</span><span class="p">)</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">update_arg</span><span class="p">(</span><span class="s1">&#39;experiment&#39;</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">update_arg</span><span class="p">(</span>
            <span class="s1">&#39;nml&#39;</span><span class="p">,</span> <span class="nb">long</span><span class="o">=</span><span class="s1">&#39;namelist&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">params_type</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="n">docstrings</span><span class="o">.</span><span class="n">dedents</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                A list from namelist parameters and their values to use.</span>
<span class="s2">                %(str_ranges.s_help)s.</span>
<span class="s2">                You can also use ``&#39;&lt;i&gt;err&#39;`` in the list which will be</span>
<span class="s2">                interpreted as ``&#39;&lt;i&gt;&#39;``-times the error from the</span>
<span class="s2">                parameterization.</span>
<span class="s2">                &quot;&quot;&quot;</span><span class="p">),</span>
            <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;nml_key=f1[,f21[-f22[-f23]]]&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">)</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">update_arg</span><span class="p">(</span><span class="s1">&#39;run_prepare&#39;</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="s1">&#39;prep&#39;</span><span class="p">)</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">update_arg</span><span class="p">(</span><span class="s1">&#39;no_move&#39;</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="s1">&#39;nm&#39;</span><span class="p">)</span>

        <span class="c1"># run parser</span>
        <span class="n">sp</span> <span class="o">=</span> <span class="n">sps</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span>
            <span class="s1">&#39;run&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Run the sensitivity analysis experiments&#39;</span><span class="p">)</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">setup_args</span><span class="p">(</span><span class="n">SensitivityAnalysis</span><span class="o">.</span><span class="n">run</span><span class="p">)</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">update_arg</span><span class="p">(</span><span class="s1">&#39;remove&#39;</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="s1">&#39;rm&#39;</span><span class="p">)</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">update_arg</span><span class="p">(</span><span class="s1">&#39;experiments&#39;</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="s1">&#39;ids&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">),</span>
                      <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;id1,id2,...&#39;</span><span class="p">)</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">pop_key</span><span class="p">(</span><span class="s1">&#39;experiments&#39;</span><span class="p">,</span> <span class="s1">&#39;nargs&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="c1"># evaluate parser</span>
        <span class="n">sp</span> <span class="o">=</span> <span class="n">sps</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span>
            <span class="s1">&#39;evaluate&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Evaluate the sensitivity analysis experiments&#39;</span><span class="p">)</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">setup_args</span><span class="p">(</span><span class="n">SensitivityAnalysis</span><span class="o">.</span><span class="n">evaluate</span><span class="p">)</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">setup_args</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">evaluate</span><span class="p">)</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">update_arg</span><span class="p">(</span><span class="s1">&#39;experiments&#39;</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="s1">&#39;ids&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">),</span>
                      <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;id1,id2,...&#39;</span><span class="p">)</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">pop_key</span><span class="p">(</span><span class="s1">&#39;experiments&#39;</span><span class="p">,</span> <span class="s1">&#39;nargs&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">update_arg</span><span class="p">(</span><span class="s1">&#39;loop_exps&#39;</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="s1">&#39;loop&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_modify_evaluate</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;prepare&#39;</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">])</span>

        <span class="c1"># plot parser</span>
        <span class="n">sp</span> <span class="o">=</span> <span class="n">sps</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span>
            <span class="s1">&#39;plot&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Plot the results sensitivity analysis experiments&#39;</span><span class="p">)</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">setup_args</span><span class="p">(</span><span class="n">SensitivityAnalysis</span><span class="o">.</span><span class="n">plot</span><span class="p">)</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="n">default_sens_config</span><span class="p">()</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">update_arg</span><span class="p">(</span><span class="s1">&#39;names&#39;</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="s1">&#39;n&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">),</span>
                      <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;variable,[variable[,...]]&#39;</span><span class="p">,</span>
                      <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="o">.</span><span class="n">names</span><span class="p">)</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">update_arg</span><span class="p">(</span><span class="s1">&#39;indicators&#39;</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">),</span>
                      <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;indicator[,indicator[,...]]&#39;</span><span class="p">,</span>
                      <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="o">.</span><span class="n">indicators</span><span class="p">)</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">update_arg</span><span class="p">(</span><span class="s1">&#39;meta&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;&lt;yaml-file&gt;&#39;</span><span class="p">)</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">unique_everseen</span><span class="p">(</span>
            <span class="n">SensitivityPlot</span><span class="o">.</span><span class="n">get_manager</span><span class="p">()</span><span class="o">.</span><span class="n">sort_by_requirement</span><span class="p">(</span>
                <span class="n">SensitivityPlot</span><span class="o">.</span><span class="n">_registry</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">plot_sps</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">add_subparsers</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;Plotting tasks&#39;</span><span class="p">,</span> <span class="n">chain</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">:</span>
            <span class="n">plot_sp</span> <span class="o">=</span> <span class="n">plot_sps</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">task</span><span class="o">.</span><span class="n">summary</span><span class="p">)</span>
            <span class="n">task</span><span class="o">.</span><span class="n">_modify_parser</span><span class="p">(</span><span class="n">plot_sp</span><span class="p">)</span>

        <span class="c1"># remove parser</span>
        <span class="n">sp</span> <span class="o">=</span> <span class="n">sps</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s1">&#39;remove&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Remove the sensitivity project&quot;</span><span class="p">)</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">setup_args</span><span class="p">(</span><span class="n">SensitivityAnalysis</span><span class="o">.</span><span class="n">remove</span><span class="p">)</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">setup_args</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remove</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_modify_remove</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">pop_arg</span><span class="p">(</span><span class="s1">&#39;projectname&#39;</span><span class="p">)</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">pop_arg</span><span class="p">(</span><span class="s1">&#39;complete&#39;</span><span class="p">)</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># ------------------------------ Miscallaneous ----------------------------</span>
    <span class="c1"># -------------------------------------------------------------------------</span>

    <span class="k">def</span> <span class="nf">_get_stations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stations</span><span class="p">,</span> <span class="n">other_exp</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">odir</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                      <span class="n">config_key</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the stations for the parameterization or evaluation</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        stations: str or list of str</span>
<span class="sd">            either a list of stations to use or a filename containing a</span>
<span class="sd">            1-row table with stations</span>
<span class="sd">        other_exp: str</span>
<span class="sd">            Use the configuration from another experiment</span>
<span class="sd">        odir: str</span>
<span class="sd">            The output directory in case a list of stations is provided</span>
<span class="sd">        config_key:</span>
<span class="sd">            The key in the :attr:`exp_config` configuration dictionary holding</span>
<span class="sd">            information on the stations</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

        <span class="n">exp_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_config</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">odir</span><span class="p">,</span> <span class="s1">&#39;stations.dat&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">odir</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">other_exp</span> <span class="ow">and</span> <span class="n">stations</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">stations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_paths</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">experiments</span><span class="p">[</span><span class="n">other_exp</span><span class="p">])</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">config_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stations</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="n">stations</span> <span class="o">=</span> <span class="p">[</span><span class="n">stations</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">stations</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="n">exp_dict</span><span class="p">[</span><span class="n">config_key</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No stations file specified!&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">exp_dict</span><span class="p">[</span><span class="n">config_key</span><span class="p">],</span>
                                      <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;S300&#39;</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">str_</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">stations</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">osp</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">stations</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">fname_use</span> <span class="o">=</span> <span class="n">stations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">exists</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span> <span class="k">if</span> <span class="n">fname</span> <span class="k">else</span> <span class="bp">False</span>
            <span class="k">if</span> <span class="n">exists</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">osp</span><span class="o">.</span><span class="n">samefile</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">fname_use</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_link</span><span class="p">(</span><span class="n">fname_use</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">exists</span> <span class="ow">and</span> <span class="n">fname</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_link</span><span class="p">(</span><span class="n">fname_use</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
            <span class="n">stations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span>
                <span class="n">fname_use</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;S300&#39;</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">str_</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">stations</span><span class="p">)</span> <span class="ow">and</span> <span class="n">fname</span><span class="p">:</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">stations</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">config_key</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">exp_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">config_key</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">osp</span><span class="o">.</span><span class="n">samefile</span><span class="p">(</span>
                <span class="n">fname</span><span class="p">,</span> <span class="n">exp_dict</span><span class="p">[</span><span class="n">config_key</span><span class="p">])):</span>
            <span class="n">exp_dict</span><span class="p">[</span><span class="n">config_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">fname</span>
        <span class="k">return</span> <span class="n">stations</span>

    <span class="k">def</span> <span class="nf">_setup_manager</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">manager</span><span class="p">,</span> <span class="n">stations</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">other_exp</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">setup_from</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">to_db</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">to_csv</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">database</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">to_return</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">complete</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">base_kws</span><span class="o">=</span><span class="p">{}):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Setup the data in a task manager</span>

<span class="sd">        This method is called by :meth:`param` and :meth:`evaluate` to setup</span>
<span class="sd">        the data in the given `manager`</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        manager: gwgen.utils.TaskManager</span>
<span class="sd">            The manager of the tasks to set up</span>
<span class="sd">        stations: list of str</span>
<span class="sd">            a list of stations to use</span>
<span class="sd">        other_exp: str</span>
<span class="sd">            Use the configuration from another experiment instead of</span>
<span class="sd">        setup_from: str</span>
<span class="sd">            Determine where to get the data from. If `scratch`, the</span>
<span class="sd">            data will be calculated from the raw data. If `file`,</span>
<span class="sd">            the data will be loaded from a file, if `db`, the data</span>
<span class="sd">            will be loaded from a postgres database (Note that the</span>
<span class="sd">            `database` argument must be provided!).</span>
<span class="sd">        to_db: bool</span>
<span class="sd">            Save the data into a postgresql database (Note that the</span>
<span class="sd">            `database` argument must be provided!)</span>
<span class="sd">        to_csv: bool</span>
<span class="sd">            Save the data into a csv file</span>
<span class="sd">        database: str</span>
<span class="sd">            The name of a postgres data base to write the data to</span>
<span class="sd">        to_return: list of str</span>
<span class="sd">            The names of the tasks to return. If None, only the ones with an</span>
<span class="sd">            :attr:`gwgen.utils.TaskBase.has_run` are returned.</span>
<span class="sd">        complete: bool</span>
<span class="sd">            If True, setup and run all possible tasks</span>
<span class="sd">        base_kws: dict</span>
<span class="sd">            The dictionary with mapping from each task name to the</span>
<span class="sd">            corresponding initialization keywords</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">complete</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">manager</span><span class="o">.</span><span class="n">base_task</span><span class="o">.</span><span class="n">_registry</span><span class="p">:</span>
                <span class="n">base_kws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">experiment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span>
        <span class="n">exp_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_paths</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">experiments</span><span class="p">[</span><span class="n">experiment</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">database</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">exp_dict</span><span class="p">[</span><span class="s1">&#39;database&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">database</span>
        <span class="c1"># setup up the keyword arguments for the parameterization tasks</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">base_kws</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;setup_from&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">d</span><span class="p">[</span><span class="s1">&#39;setup_from&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">setup_from</span>
            <span class="k">if</span> <span class="n">to_csv</span><span class="p">:</span>
                <span class="n">d</span><span class="p">[</span><span class="s1">&#39;to_csv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">to_csv</span>
            <span class="k">elif</span> <span class="n">to_csv</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;to_csv&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="c1"># delete the argument if the subparser doesn&#39;t use it</span>
                <span class="n">d</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;to_csv&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">to_db</span><span class="p">:</span>
                <span class="c1"># delete the argument if the subparser doesn&#39;t use it</span>
                <span class="n">d</span><span class="p">[</span><span class="s1">&#39;to_db&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">to_db</span>
            <span class="k">elif</span> <span class="n">to_db</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;to_db&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">d</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;to_db&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">other_exp</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;other_exp&#39;</span><span class="p">):</span>
                <span class="n">d</span><span class="p">[</span><span class="s1">&#39;other_exp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">other_exp</span>
            <span class="n">exp</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;other_exp&#39;</span><span class="p">,</span> <span class="n">experiment</span><span class="p">)</span> <span class="ow">or</span> <span class="n">experiment</span>
            <span class="n">d</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_paths</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">experiments</span><span class="p">[</span><span class="n">exp</span><span class="p">])</span>
            <span class="n">d</span><span class="p">[</span><span class="s1">&#39;project_config&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">projects</span><span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">][</span><span class="s1">&#39;project&#39;</span><span class="p">]]</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;stations&#39;</span><span class="p">,</span> <span class="s1">&#39;complete&#39;</span><span class="p">,</span> <span class="s1">&#39;norun&#39;</span><span class="p">,</span> <span class="s1">&#39;other_id&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;database&#39;</span><span class="p">]:</span>
                <span class="n">d</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="c1"># choose keywords for data processing</span>
        <span class="n">manager</span><span class="o">.</span><span class="n">initialize_tasks</span><span class="p">(</span><span class="n">stations</span><span class="p">,</span> <span class="n">task_kws</span><span class="o">=</span><span class="n">base_kws</span><span class="p">)</span>
        <span class="n">manager</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">stations</span><span class="p">,</span> <span class="n">to_return</span><span class="o">=</span><span class="n">to_return</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_modify_task_parser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span> <span class="n">base_task</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">only</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">norun</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="bp">True</span> <span class="ow">or</span> <span class="n">s</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">True</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="n">skip</span> <span class="o">=</span> <span class="n">skip</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">only</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">key_func</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">skip</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">key_func</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">only</span> <span class="ow">and</span> <span class="n">t</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">skip</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_modify_app_main</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">update_arg</span><span class="p">(</span><span class="s1">&#39;setup_from&#39;</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="nb">long</span><span class="o">=</span><span class="s1">&#39;from&#39;</span><span class="p">,</span>
                          <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;setup_from&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">update_arg</span><span class="p">(</span><span class="s1">&#39;other_exp&#39;</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="s1">&#39;ido&#39;</span><span class="p">,</span> <span class="nb">long</span><span class="o">=</span><span class="s1">&#39;other_id&#39;</span><span class="p">,</span>
                          <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;other_exp&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">update_arg</span><span class="p">(</span><span class="s1">&#39;stations&#39;</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">update_arg</span><span class="p">(</span><span class="s1">&#39;database&#39;</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="s1">&#39;db&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">pop_arg</span><span class="p">(</span><span class="s1">&#39;to_return&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">update_arg</span><span class="p">(</span>
            <span class="s1">&#39;norun&#39;</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="s1">&#39;nr&#39;</span><span class="p">,</span> <span class="n">const</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;?&#39;</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="n">norun</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="p">(</span>
                <span class="s1">&#39;If set without value or &quot;all&quot; or a number different from 0, &#39;</span>
                <span class="s1">&#39;the data is set up and the configuration of the &#39;</span>
                <span class="s1">&#39;experiment is not affected. Otherwise it can be a comma &#39;</span>
                <span class="s1">&#39;separated list of parameterization tasks for which to only &#39;</span>
                <span class="s1">&#39;setup the data&#39;</span><span class="p">),</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;task1,task2,...&#39;</span><span class="p">)</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="n">docstrings</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;GWGENOrganizer.param.parameters&#39;</span><span class="p">]</span>
        <span class="n">setup_from_doc</span><span class="p">,</span> <span class="n">setup_from_dtype</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">get_param_doc</span><span class="p">(</span>
            <span class="n">doc</span><span class="p">,</span> <span class="s1">&#39;setup_from&#39;</span><span class="p">)</span>
        <span class="n">other_exp_doc</span><span class="p">,</span> <span class="n">other_exp_dtype</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">get_param_doc</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="s1">&#39;other_exp&#39;</span><span class="p">)</span>

        <span class="n">tasks</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="n">key_func</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">unique_everseen</span><span class="p">(</span>
            <span class="n">base_task</span><span class="o">.</span><span class="n">get_manager</span><span class="p">()</span><span class="o">.</span><span class="n">sort_by_requirement</span><span class="p">(</span>
                <span class="n">base_task</span><span class="o">.</span><span class="n">_registry</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="n">sps</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_subparsers</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Tasks&#39;</span><span class="p">,</span> <span class="n">chain</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">:</span>
            <span class="n">sp</span> <span class="o">=</span> <span class="n">sps</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">task</span><span class="o">.</span><span class="n">summary</span><span class="p">,</span>
                                <span class="n">formatter_class</span><span class="o">=</span><span class="n">RawTextHelpFormatter</span><span class="p">)</span>
            <span class="n">task</span><span class="o">.</span><span class="n">_modify_parser</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
            <span class="n">sp</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s1">&#39;-ido&#39;</span><span class="p">,</span> <span class="s1">&#39;--other_id&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">other_exp_doc</span><span class="p">,</span>
                <span class="n">metavar</span><span class="o">=</span><span class="n">other_exp_dtype</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_link</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Link two files</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        source: str</span>
<span class="sd">            The path of the source file</span>
<span class="sd">        target: str</span>
<span class="sd">            The path of the target file&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;copy&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span> <span class="ow">and</span> <span class="n">osp</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;use_relative_links&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">osp</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">osp</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">target</span><span class="p">)),</span> <span class="n">target</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">osp</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">source</span><span class="p">),</span> <span class="n">target</span><span class="p">)</span></div>


<div class="viewcode-block" id="exponential_function"><a class="viewcode-back" href="../../api/gwgen.main.html#gwgen.main.exponential_function">[docs]</a><span class="k">def</span> <span class="nf">exponential_function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Exponential function used by :meth:`GWGENOrganizer.wind_bias_correction`</span>

<span class="sd">    This function is defined as</span>

<span class="sd">    .. math::</span>

<span class="sd">        f(x) = e^{ax + b}</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x: numpy.ndarray</span>
<span class="sd">        The x-data</span>
<span class="sd">    a: float</span>
<span class="sd">        The *a* parameter in the above equation</span>
<span class="sd">    b: float</span>
<span class="sd">        The *b* parameter in the above equation</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        The calculated :math:`f(x)`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span></div>


<div class="viewcode-block" id="logistic_function"><a class="viewcode-back" href="../../api/gwgen.main.html#gwgen.main.logistic_function">[docs]</a><span class="k">def</span> <span class="nf">logistic_function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">x0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Logistic function used in :meth:`GWGENOrganizer.wind_bias_correction`</span>

<span class="sd">    The function is defined as</span>

<span class="sd">    .. math::</span>

<span class="sd">        f(x) = \\frac{L}{1 + \\mathrm e^{-k(x-x_0)}}</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x: numpy.ndarray</span>
<span class="sd">        The x-data</span>
<span class="sd">    L: float</span>
<span class="sd">        the curve&#39;s maximum value</span>
<span class="sd">    k: float</span>
<span class="sd">        The steepness of the curve</span>
<span class="sd">    x0: the x-value of the sigmoid&#39;s midpoint</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        The calculated :math:`f(x)`&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">L</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)))</span></div>


<span class="k">def</span> <span class="nf">_get_parser</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Function returning the gwgen parser, necessary for sphinx documentation</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">GWGENOrganizer</span><span class="o">.</span><span class="n">get_parser</span><span class="p">()</span>


<div class="viewcode-block" id="main"><a class="viewcode-back" href="../../api/gwgen.main.html#gwgen.main.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Call the :meth:`~model_organization.GWGENOrganizer.main` method of the</span>
<span class="sd">    :class:`GWGENOrganizer` class&quot;&quot;&quot;</span>
    <span class="n">GWGENOrganizer</span><span class="o">.</span><span class="n">main</span><span class="p">(</span><span class="n">args</span><span class="p">)</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">gwgen</a></h1>






<p>
<iframe src="https://ghbtns.com/github-btn.html?user=ARVE-Research&repo=gwgen&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





    

<p>
<a href="https://travis-ci.org/ARVE-Research/gwgen">
    <img
        alt="https://secure.travis-ci.org/ARVE-Research/gwgen.svg?branch=master"
        src="https://secure.travis-ci.org/ARVE-Research/gwgen.svg?branch=master"
    />
</a>
</p>


<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../command_line/gwgen.html">Command Line API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/gwgen.html">Python API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fortran_api/index.html">Fortran API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog.html">Changelog</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2016, Philipp Sommer.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.3.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
    </div>

    

    
  </body>
</html>